<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Esquinazo – Gestión de Clientes</title>
  
  <style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --muted:#334155;
  --text:#e5e7eb;
  --sub:#cbd5e1;
  --brand:#22c55e;
  --brand-2:#06b6d4;
  --danger:#ef4444;
  --warning:#f59e0b;
  --ok:#10b981;
  --card:#0b1224;
  --border:#1f2937;
  --shadow: 0 6px 24px rgba(0,0,0,.35);
  --radius:16px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(180deg,var(--bg),#0b1224 60%);
  color:var(--text);
}

.login-container{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.login-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:20px;
  padding:40px;
  max-width:420px;
  width:100%;
  box-shadow:var(--shadow);
}
.login-header{
  text-align:center;
  margin-bottom:32px;
}
.login-header .logo{
  font-size:48px;
  margin-bottom:12px;
}
.login-header h1{
  margin:0 0 8px;
  font-size:28px;
}
.login-header p{
  margin:0;
  color:var(--sub);
  font-size:14px;
}

.topbar{
  position:sticky; top:0; z-index:10;
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:12px 16px;
  background:rgba(15,23,42,.95);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{display:flex; align-items:center; gap:10px}
.brand .logo{font-size:22px}
.brand h1{font-size:18px; margin:0}

.user-info{
  display:flex;
  align-items:center;
  gap:12px;
  color:var(--sub);
  font-size:14px;
}
.user-email{
  padding:6px 12px;
  background:rgba(6,182,212,.1);
  border-radius:8px;
  border:1px solid rgba(6,182,212,.3);
}

.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  background:transparent;
  border:1px solid var(--border);
  color:var(--sub);
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  transition: all .2s;
}
.tab:hover{background:rgba(255,255,255,.05)}
.tab.is-active{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:600}

main#app{padding:16px; max-width:1100px; margin-inline:auto; min-height: calc(100vh - 180px)}
.view{display:none}
.view.is-active{display:block}

.cards{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
}
@media(min-width:720px){
  .cards{grid-template-columns: repeat(3, 1fr);}
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow: var(--shadow);
}
.kpi h3{margin:0 0 6px; color:var(--sub); font-weight:500; font-size:14px}
.kpi-value{font-size:28px; margin:4px 0 0; font-weight:800; color:var(--brand-2)}
.kpi-value.danger{color:var(--danger)}

.section{margin-top:22px}
.section h3{margin:0 0 10px; font-size:18px}

.btn{
  background:#121b31;
  color:var(--text);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:.2s all ease;
  font-size:14px;
  font-weight:500;
}
.btn:hover{transform:translateY(-1px); border-color:#2b3b55}
.btn:active{transform:translateY(0)}
.btn.primary{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:700}
.btn.success{background:var(--ok); color:#00170f; border-color:transparent; font-weight:700; text-decoration:none; display:inline-block}
.btn.light{background:transparent; color:var(--sub)}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.btn:disabled{opacity:.5; cursor:not-allowed}
.btn.full-width{width:100%}

.actions-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.list{display:grid; gap:10px}
.empty-hint:empty::after{
  content:"Sin clientes registrados.";
  color:var(--muted);
  padding:12px 16px;
  background:rgba(255,255,255,0.02);
  border:1px dashed var(--border);
  border-radius:12px;
  display:block;
}

.item{
  display:flex; gap:12px; justify-content:space-between; align-items:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.item:hover{border-color:var(--muted)}
.item .meta{display:flex; flex-direction:column; gap:4px; flex:1}
.item .title{font-weight:700; font-size:16px}
.item .sub{display:flex; gap:6px; flex-wrap:wrap}
.badge{
  padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
  border:1px solid var(--border); color:var(--sub); background:#0e162b;
}
.badge.red{color:#fff; background:var(--danger); border-color:transparent}
.badge.amber{color:#1b1000; background:var(--warning); border-color:transparent}

.toolbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap;
}
.search-box{position:relative; display:flex; align-items:center; flex:1; max-width:400px}
.search-box input{
  background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:12px;
  padding:10px 12px; width:100%;
}

.ficha-header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap}
.ficha-titulos h2{margin:0; font-size:24px}
.saldo{margin:4px 0 0; color:var(--sub); font-weight:700; font-size:16px}

.table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--panel)}
.table{width:100%; border-collapse:collapse; min-width:600px}
.table th, .table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
.table thead th{background:#0c1427; color:var(--sub); font-weight:600}
.table tbody tr:hover{background:#0c1427}
.table tbody tr:last-child td{border-bottom:0}
.table .num{text-align:right}
.table .btn-icon{padding:4px 8px; font-size:12px}

.grid{display:grid; gap:12px; grid-template-columns:1fr}
@media(min-width:600px){
  .grid{grid-template-columns:repeat(2, 1fr)}
}
.grid .full{grid-column:1/-1}
label{display:block}
label span{display:block; font-size:14px; color:var(--sub); margin-bottom:6px; font-weight:500}
input, select{
  width:100%; background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  font-family:inherit; font-size:14px;
}
input:focus, select:focus{outline:2px solid rgba(6,182,212,.3); border-color:var(--brand-2)}

.modal{border:0; padding:0; background:transparent; max-width:90vw}
.modal::backdrop{background:rgba(0,0,0,.7); backdrop-filter:blur(2px)}
.modal-content{
  background:var(--panel); color:var(--text);
  border:1px solid var(--border); border-radius:16px; 
  min-width:min(640px,90vw);
  padding:0; box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal-header{
  display:flex; align-items:center; justify-content:space-between; 
  padding:16px 20px; border-bottom:1px solid var(--border);
}
.modal-header h3{margin:0; font-size:18px}
.modal-actions{
  display:flex; gap:10px; justify-content:flex-end; 
  padding:16px 20px; border-top:1px solid var(--border);
}
.modal-content .grid{padding:20px}

.loading{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  gap:16px;
}
.spinner{
  display:inline-block; width:40px; height:40px;
  border:4px solid rgba(255,255,255,.2);
  border-top-color:var(--brand-2);
  border-radius:50%; 
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.error-msg{
  color:var(--danger);
  font-size:13px;
  margin-top:8px;
  display:none;
}
.error-msg.show{display:block}

.hidden{display:none!important}

.footer{padding:24px 16px; text-align:center; color:var(--muted); font-size:13px; border-top:1px solid var(--border); margin-top:40px}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <div class="logo">🎲</div>
        <h1>El Esquinazo</h1>
        <p>Sistema de gestión de clientes</p>
      </div>

      <form id="form-signin">
        <div class="grid">
          <label class="full">
            <span>Email</span>
            <input type="email" name="email" required placeholder="tu@email.com" />
          </label>
          <label class="full">
            <span>Contraseña</span>
            <input type="password" name="password" required placeholder="••••••••" />
          </label>
        </div>
        <div class="error-msg" id="signin-error"></div>
        <button type="submit" class="btn primary full-width" style="margin-top:20px">
          Ingresar
        </button>
      </form>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading-screen" class="loading hidden">
    <div class="spinner"></div>
    <p style="color:var(--sub)">Cargando...</p>
  </div>

  <!-- APP -->
  <div id="main-app" class="hidden">
    <header class="topbar">
      <div class="brand">
        <span class="logo">🎲</span>
        <h1>El Esquinazo</h1>
      </div>
      <div class="user-info">
        <span class="user-email" id="user-email">usuario@ejemplo.com</span>
        <button class="btn light" id="btn-logout">Cerrar Sesión</button>
      </div>
      <nav class="tabs">
        <button class="tab is-active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="clientes">Clientes</button>
      </nav>
    </header>

    <main id="app">
      <!-- DASHBOARD -->
      <section id="dashboard" class="view is-active">
        <div class="cards">
          <article class="card kpi">
            <h3>Fiado Total</h3>
            <p id="kpi-fiado" class="kpi-value danger">$0</p>
          </article>
          <article class="card kpi">
            <h3>Clientes con Deuda</h3>
            <p id="kpi-condeuda" class="kpi-value">0</p>
          </article>
          <article class="card kpi">
            <h3>Deudas Vencidas</h3>
            <p id="kpi-vencidas" class="kpi-value danger">0</p>
          </article>
        </div>

        <div class="section">
          <h3>Acciones Rápidas</h3>
          <div class="actions-row">
            <button id="btn-nuevo-cliente-rapido" class="btn primary">+ Añadir Cliente</button>
          </div>
        </div>

        <div class="section">
          <h3>Deudas Vencidas</h3>
          <div id="lista-vencidas" class="list empty-hint"></div>
        </div>
      </section>

      <!-- CLIENTES -->
      <section id="clientes" class="view">
        <div class="toolbar">
          <div class="search-box">
            <input id="buscar-clientes" type="search" placeholder="Buscar cliente..." />
          </div>
          <button id="btn-add-cliente" class="btn primary">+ Añadir Cliente</button>
        </div>
        <div id="lista-clientes" class="list empty-hint"></div>
      </section>

      <!-- FICHA -->
      <section id="ficha" class="view" hidden>
        <div class="ficha-header">
          <button class="btn light" id="volver-clientes">← Volver</button>
          <div class="ficha-titulos">
            <h2 id="ficha-nombre">Cliente</h2>
            <p id="ficha-saldo" class="saldo">DEUDA: $0</p>
          </div>
        </div>

        <div class="actions-row">
          <button id="btn-registrar-pago" class="btn">Registrar Pago</button>
          <button id="btn-registrar-jugada" class="btn primary">Añadir Jugada</button>
          <a id="btn-whatsapp" class="btn success" target="_blank">WhatsApp</a>
        </div>

        <div class="section">
          <h3>Historial</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th class="num">Debe</th>
                  <th class="num">Haber</th>
                  <th class="num">Saldo</th>
                  <th class="num">Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-historial"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <small>© <span id="year"></span> El Esquinazo – Sistema de gestión simple</small>
    </footer>

    <!-- MODALES -->
    <dialog id="modal-cliente" class="modal">
      <form method="dialog" class="modal-content" id="form-cliente">
        <header class="modal-header">
          <h3 id="modal-cliente-titulo">Nuevo Cliente</h3>
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">×</button>
        </header>
        <div class="grid">
          <label class="full">
            <span>Nombre y Apellido</span>
            <input name="nombre" type="text" required placeholder="Ej: Juan Pérez" />
          </label>
          <label class="full">
            <span>WhatsApp (sin 0 ni 15)</span>
            <div style="display:flex; gap:8px">
              <span style="padding:10px; background:#0e162b; border:1px solid var(--border); border-radius:10px">+54 9</span>
              <input name="whatsapp" type="tel" placeholder="3492123456" style="flex:1" />
            </div>
          </label>
        </div>
        <footer class="modal-actions">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </footer>
        <input type="hidden" name="id" />
      </form>
    </dialog>

    <dialog id="modal-mov" class="modal">
      <form method="dialog" class="modal-content" id="form-mov">
        <header class="modal-header">
          <h3 id="modal-mov-titulo">Movimiento</h3>
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">×</button>
        </header>
        <div class="grid">
          <label>
            <span>Fecha</span>
            <input name="fecha" type="date" required />
          </label>
          <label>
            <span>Tipo</span>
            <select name="tipo" required>
              <option value="jugada">Jugada/Fiado</option>
              <option value="pago">Pago</option>
            </select>
          </label>
          <label class="full">
            <span>Descripción</span>
            <input name="descripcion" type="text" placeholder="Ej: Quiniela" />
          </label>
          <label>
            <span>Monto</span>
            <input name="monto" type="number" min="0" step="0.01" required />
          </label>
        </div>
        <footer class="modal-actions">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </footer>
        <input type="hidden" name="clienteId" />
        <input type="hidden" name="movId" />
      </form>
    </dialog>

    <dialog id="modal-confirm" class="modal">
      <form method="dialog" class="modal-content">
        <header class="modal-header">
          <h3>Confirmar</h3>
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">×</button>
        </header>
        <p id="confirm-msg" style="padding:20px; margin:0">¿Estás seguro?</p>
        <footer class="modal-actions">
          <button type="button" class="btn" onclick="this.closest('dialog').close()">No</button>
          <button type="submit" class="btn danger">Sí, eliminar</button>
        </footer>
      </form>
    </dialog>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuHOmx6K4_7ke85fdlrnQlOGAfMI7bQf4",
      authDomain: "el-esquinazo-9d73f.firebaseapp.com",
      projectId: "el-esquinazo-9d73f",
      storageBucket: "el-esquinazo-9d73f.firebasestorage.app",
      messagingSenderId: "546263167857",
      appId: "1:546263167857:web:c44e73f6c41e7b81403cd0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let state = {
      user: null,
      clientes: [],
      fichaClienteId: null,
    };

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmtMoney = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS", maximumFractionDigits: 0 }).format(n || 0);
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const parseDate = (iso) => new Date(iso + "T00:00:00");
    const daysBetween = (isoDate) => Math.floor(((new Date()) - parseDate(isoDate)) / 86400000);
    const uid = () => Math.random().toString(36).slice(2, 10);
    const sanitizePhone = (p) => {
      const d = (p || "").replace(/\D+/g, "");
      return d ? (d.startsWith("549") ? d : "549" + d) : "";
    };
    const fmtFecha = (iso) => {
      const [y, m, d] = iso.split("-");
      return `${d}/${m}/${y.slice(-2)}`;
    };

    // Auth
    $('#form-signin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('#form-signin').email.value.trim();
      const password = $('#form-signin').password.value;
      $('#signin-error').textContent = '';
      $('#signin-error').classList.remove('show');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        $('#signin-error').textContent = 'Email o contraseña incorrectos';
        $('#signin-error').classList.add('show');
      }
    });

    $('#btn-logout').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        state.user = user;
        $('#user-email').textContent = user.email;
        $('#login-screen').classList.add('hidden');
        $('#loading-screen').classList.remove('hidden');
        await cargarDatos();
        $('#loading-screen').classList.add('hidden');
        $('#main-app').classList.remove('hidden');
        renderAll();
      } else {
        state.user = null;
        $('#main-app').classList.add('hidden');
        $('#loading-screen').classList.add('hidden');
        $('#login-screen').classList.remove('hidden');
      }
    });

    async function cargarDatos() {
      if (!state.user) return;
      const snap = await getDocs(collection(db, 'clientes'));
      state.clientes = [];
      snap.forEach(doc => state.clientes.push({ id: doc.id, ...doc.data() }));
    }

    async function guardarCliente(cliente) {
      if (!state.user) return;
      await setDoc(doc(db, 'clientes', cliente.id), cliente);
    }

    async function eliminarCliente(id) {
      if (!state.user) return;
      await deleteDoc(doc(db, 'clientes', id));
    }

    function saldoCliente(c) {
      return (c.movs || []).reduce((acc, m) => acc + (m.debe || 0) - (m.haber || 0), 0);
    }

    function tieneDeuda(c) {
      return saldoCliente(c) > 0;
    }

    function isDeudaVencida(c) {
      if (!tieneDeuda(c)) return false;
      return (c.movs || []).some(m => m.tipo === "jugada" && daysBetween(m.fecha) > 30);
    }

    function renderDashboard() {
      const fiadoTotal = state.clientes.reduce((acc, c) => acc + saldoCliente(c), 0);
      const conDeuda = state.clientes.filter(tieneDeuda).length;
      const vencidas = state.clientes.filter(isDeudaVencida).length;
      
      $('#kpi-fiado').textContent = fmtMoney(fiadoTotal);
      $('#kpi-condeuda').textContent = conDeuda;
      $('#kpi-vencidas').textContent = vencidas;

      const cont = $('#lista-vencidas');
      cont.innerHTML = "";
      const list = state.clientes
        .filter(c => isDeudaVencida(c))
        .sort((a, b) => saldoCliente(b) - saldoCliente(a));

      list.forEach(c => {
        const saldo = saldoCliente(c);
        const dias = Math.max(...(c.movs || []).filter(m => m.tipo === "jugada").map(m => daysBetween(m.fecha)));
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              <span class="badge red">${fmtMoney(saldo)}</span>
              <span class="badge amber">${dias} días</span>
            </div>
          </div>
          <div class="actions-row">
            ${c.whatsapp ? `<a class="btn success" target="_blank" href="https://wa.me/${sanitizePhone(c.whatsapp)}?text=${encodeURIComponent('Hola '+c.nombre+', te escribo de El Esquinazo por la deuda de '+fmtMoney(saldo))}">WhatsApp</a>` : ''}
            <button class="btn light" onclick="abrirFicha('${c.id}')">Ver</button>
          </div>
        `;
        cont.appendChild(div);
      });
    }

    function renderClientes(filter = "") {
      const cont = $('#lista-clientes');
      cont.innerHTML = "";
      const q = filter.trim().toLowerCase();
      const list = [...state.clientes]
        .sort((a, b) => a.nombre.localeCompare(b.nombre))
        .filter(c => !q || c.nombre.toLowerCase().includes(q));

      list.forEach(c => {
        const saldo = saldoCliente(c);
        const vencida = isDeudaVencida(c);
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              <span class="badge ${saldo > 0 ? 'red' : ''}">${fmtMoney(saldo)}</span>
              ${vencida ? '<span class="badge amber">Vencida</span>' : ''}
            </div>
          </div>
          <div class="actions-row">
            ${c.whatsapp ? `<a class="btn success" target="_blank" href="https://wa.me/${sanitizePhone(c.whatsapp)}">WhatsApp</a>` : ''}
            <button class="btn light" onclick="abrirEditarCliente('${c.id}')">Editar</button>
            <button class="btn danger" onclick="confirmarEliminarCliente('${c.id}')">Eliminar</button>
            <button class="btn primary" onclick="abrirFicha('${c.id}')">Ver Ficha</button>
          </div>
        `;
        cont.appendChild(div);
      });
    }

    window.abrirFicha = function(id) {
      state.fichaClienteId = id;
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#ficha-nombre').textContent = c.nombre;
      const saldo = saldoCliente(c);
      $('#ficha-saldo').textContent = `DEUDA: ${fmtMoney(saldo)}`;
      if (c.whatsapp) {
        $('#btn-whatsapp').href = `https://wa.me/${sanitizePhone(c.whatsapp)}`;
        $('#btn-whatsapp').style.display = 'inline-block';
      } else {
        $('#btn-whatsapp').style.display = 'none';
      }
      renderHistorial(c);
      switchView('ficha');
    };

    function renderHistorial(c) {
      const tbody = $('#tabla-historial');
      tbody.innerHTML = "";
      const movs = [...(c.movs || [])].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
      let saldo = 0;
      movs.forEach(m => {
        saldo += (m.debe || 0) - (m.haber || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtFecha(m.fecha)}</td>
          <td>${m.descripcion || "-"}</td>
          <td class="num">${m.debe ? fmtMoney(m.debe) : "-"}</td>
          <td class="num">${m.haber ? fmtMoney(m.haber) : "-"}</td>
          <td class="num"><strong>${fmtMoney(saldo)}</strong></td>
          <td class="num">
            <button class="btn btn-icon light" onclick="abrirEditarMov('${c.id}','${m.id}')">✏️</button>
            <button class="btn btn-icon danger" onclick="confirmarEliminarMov('${c.id}','${m.id}')">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function switchView(id) {
      $$('.view').forEach(v => {
        v.classList.remove('is-active');
        v.setAttribute('hidden', '');
      });
      const view = $('#'+id);
      view.classList.add('is-active');
      view.removeAttribute('hidden');
      
      $$('.tab').forEach(t => t.classList.remove('is-active'));
      const tab = $(`.tab[data-tab="${id}"]`);
      if (tab) tab.classList.add('is-active');
    }

    // Modales
    window.abrirNuevoCliente = function() {
      $('#form-cliente').reset();
      $('#form-cliente').id.value = '';
      $('#modal-cliente-titulo').textContent = 'Nuevo Cliente';
      $('#modal-cliente').showModal();
    };

    window.abrirEditarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#form-cliente').reset();
      $('#form-cliente').id.value = c.id;
      $('#form-cliente').nombre.value = c.nombre;
      $('#form-cliente').whatsapp.value = (c.whatsapp || "").replace(/^549/, "");
      $('#modal-cliente-titulo').textContent = 'Editar Cliente';
      $('#modal-cliente').showModal();
    };

    $('#form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = $('#form-cliente').id.value || uid();
      const nombre = $('#form-cliente').nombre.value.trim();
      const whatsapp = sanitizePhone($('#form-cliente').whatsapp.value);
      if (!nombre) return;

      const idx = state.clientes.findIndex(x => x.id === id);
      if (idx >= 0) {
        state.clientes[idx].nombre = nombre;
        state.clientes[idx].whatsapp = whatsapp;
        await guardarCliente(state.clientes[idx]);
      } else {
        const nuevo = { id, nombre, whatsapp, movs: [] };
        state.clientes.push(nuevo);
        await guardarCliente(nuevo);
      }
      $('#modal-cliente').close();
      renderAll();
    });

    window.confirmarEliminarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#confirm-msg').textContent = `¿Eliminar a "${c.nombre}" y todo su historial?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async () => {
        state.clientes = state.clientes.filter(x => x.id !== id);
        await eliminarCliente(id);
        if (state.fichaClienteId === id) {
          state.fichaClienteId = null;
          switchView('clientes');
        }
        renderAll();
      };
    };

    window.abrirNuevoMov = function(tipo) {
      $('#form-mov').reset();
      $('#form-mov').fecha.value = todayISO();
      $('#form-mov').tipo.value = tipo;
      $('#form-mov').clienteId.value = state.fichaClienteId;
      $('#form-mov').movId.value = '';
      $('#modal-mov-titulo').textContent = tipo === 'pago' ? 'Registrar Pago' : 'Registrar Jugada';
      $('#modal-mov').showModal();
    };

    window.abrirEditarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#form-mov').reset();
      $('#form-mov').fecha.value = m.fecha;
      $('#form-mov').tipo.value = m.tipo;
      $('#form-mov').descripcion.value = m.descripcion || '';
      $('#form-mov').monto.value = m.tipo === 'jugada' ? m.debe : m.haber;
      $('#form-mov').clienteId.value = clienteId;
      $('#form-mov').movId.value = movId;
      $('#modal-mov-titulo').textContent = 'Editar Movimiento';
      $('#modal-mov').showModal();
    };

    $('#form-mov').addEventListener('submit', async (e) => {
      e.preventDefault();
      const clienteId = $('#form-mov').clienteId.value;
      const movId = $('#form-mov').movId.value;
      const c = state.clientes.find(x => x.id === clienteId);
      if (!c) return;

      const tipo = $('#form-mov').tipo.value;
      const fecha = $('#form-mov').fecha.value;
      const descripcion = $('#form-mov').descripcion.value.trim();
      const monto = Math.max(0, Number($('#form-mov').monto.value || 0));

      if (!fecha || !monto) return;

      if (movId) {
        const mov = c.movs.find(x => x.id === movId);
        if (mov) {
          mov.fecha = fecha;
          mov.tipo = tipo;
          mov.descripcion = descripcion;
          mov.debe = tipo === 'jugada' ? monto : 0;
          mov.haber = tipo === 'pago' ? monto : 0;
        }
      } else {
        c.movs.push({
          id: uid(),
          fecha,
          tipo,
          descripcion,
          debe: tipo === 'jugada' ? monto : 0,
          haber: tipo === 'pago' ? monto : 0,
        });
      }

      await guardarCliente(c);
      $('#modal-mov').close();
      if (state.fichaClienteId === clienteId) renderHistorial(c);
      renderAll();
    });

    window.confirmarEliminarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#confirm-msg').textContent = `¿Eliminar el movimiento "${m.descripcion || m.tipo}"?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async () => {
        c.movs = c.movs.filter(x => x.id !== movId);
        await guardarCliente(c);
        renderHistorial(c);
        renderAll();
      };
    };

    // Eventos
    $$('.tab').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.tab)));
    $('#btn-nuevo-cliente-rapido').addEventListener('click', abrirNuevoCliente);
    $('#btn-add-cliente').addEventListener('click', abrirNuevoCliente);
    $('#buscar-clientes').addEventListener('input', (e) => renderClientes(e.target.value));
    $('#volver-clientes').addEventListener('click', () => switchView('clientes'));
    $('#btn-registrar-pago').addEventListener('click', () => abrirNuevoMov('pago'));
    $('#btn-registrar-jugada').addEventListener('click', () => abrirNuevoMov('jugada'));
    $('#year').textContent = new Date().getFullYear();

    function renderAll() {
      renderDashboard();
      renderClientes($('#buscar-clientes').value || '');
    }

    console.log("🎲 El Esquinazo – Sistema cargado");
  </script>
</body>
</html>
