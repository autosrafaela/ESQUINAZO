<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Esquinazo ‚Äì Gesti√≥n de Clientes</title>
  
  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --muted:#334155;
  --text:#e5e7eb;
  --sub:#cbd5e1;
  --brand:#22c55e;
  --brand-2:#06b6d4;
  --danger:#ef4444;
  --warning:#f59e0b;
  --ok:#10b981;
  --card:#0b1224;
  --border:#1f2937;
  --shadow: 0 6px 24px rgba(0,0,0,.35);
  --radius:16px;
  --mora:#f97316;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(180deg,var(--bg),#0b1224 60%);
  color:var(--text);
}

.login-container{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.login-container[hidden]{
  display:none !important;
}
.login-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:20px;
  padding:40px;
  max-width:420px;
  width:100%;
  box-shadow:var(--shadow);
}
.login-header{
  text-align:center;
  margin-bottom:32px;
}
.login-header .logo{
  font-size:48px;
  margin-bottom:12px;
}
.login-header h1{
  margin:0 0 8px;
  font-size:28px;
}
.login-header p{
  margin:0;
  color:var(--sub);
  font-size:14px;
}

.topbar{
  position:sticky; top:0; z-index:10;
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:12px 16px;
  background:rgba(15,23,42,.95);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{display:flex; align-items:center; gap:10px}
.brand .logo{font-size:22px}
.brand h1{font-size:18px; margin:0}

.user-info{
  display:flex;
  align-items:center;
  gap:12px;
  color:var(--sub);
  font-size:14px;
}
.user-email{
  padding:6px 12px;
  background:rgba(6,182,212,.1);
  border-radius:8px;
  border:1px solid rgba(6,182,212,.3);
}

.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  background:transparent;
  border:1px solid var(--border);
  color:var(--sub);
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  transition: all .2s;
}
.tab:hover{background:rgba(255,255,255,.05)}
.tab.is-active{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:600}

main#app{padding:16px; max-width:1100px; margin-inline:auto; min-height: calc(100vh - 180px)}
.view{display:none}
.view.is-active{display:block}

.cards{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
}
@media(min-width:720px){
  .cards{grid-template-columns: repeat(3, 1fr);}
}
@media(min-width:1024px){
  .cards.five-cols{grid-template-columns: repeat(5, 1fr);}
  .cards.six-cols{grid-template-columns: repeat(6, 1fr);}
  .cards.four-cols{grid-template-columns: repeat(4, 1fr);}
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow: var(--shadow);
}
.card.mora-alert{
  border-color: var(--mora);
  background: rgba(249,115,22,0.08);
  animation: pulse-mora 2s infinite;
}
@keyframes pulse-mora {
  0%, 100% { box-shadow: 0 0 0 0 rgba(249,115,22,0.3); }
  50% { box-shadow: 0 0 0 6px rgba(249,115,22,0); }
}
.kpi h3{margin:0 0 6px; color:var(--sub); font-weight:500; font-size:14px}
.kpi-value{font-size:28px; margin:4px 0 0; font-weight:800; color:var(--brand-2)}
.kpi-value.danger{color:var(--danger)}
.kpi-value.success{color:var(--ok)}
.kpi-value.mora{color:var(--mora)}

.section{margin-top:22px}
.section h3{margin:0 0 10px; font-size:18px}

.btn{
  background:#121b31;
  color:var(--text);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:.2s all ease;
  font-size:14px;
  font-weight:500;
}
.btn:hover{transform:translateY(-1px); border-color:#2b3b55}
.btn:active{transform:translateY(0)}
.btn.primary{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:700}
.btn.success{background:var(--ok); color:#00170f; border-color:transparent; font-weight:700; text-decoration:none; display:inline-block}
.btn.warning{background:var(--warning); color:#1b1000; border-color:transparent; font-weight:700}
.btn.mora{background:var(--mora); color:#fff; border-color:transparent; font-weight:700}
.btn.light{background:transparent; color:var(--sub)}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.btn:disabled{opacity:.5; cursor:not-allowed}
.btn.full-width{width:100%}

.actions-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.list{display:grid; gap:10px}
.empty-hint:empty::after{
  content:"Sin clientes registrados.";
  color:var(--muted);
  padding:12px 16px;
  background:rgba(255,255,255,0.02);
  border:1px dashed var(--border);
  border-radius:12px;
  display:block;
}

.item{
  display:flex; gap:12px; justify-content:space-between; align-items:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.item:hover{border-color:var(--muted)}
.item.mora-item{border-color:var(--mora); background:rgba(249,115,22,0.05)}
.item .meta{display:flex; flex-direction:column; gap:4px; flex:1}
.item .title{font-weight:700; font-size:16px}
.item .sub{display:flex; gap:6px; flex-wrap:wrap}
.badge{
  padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
  border:1px solid var(--border); color:var(--sub); background:#0e162b;
}
.badge.red{color:#fff; background:var(--danger); border-color:transparent}
.badge.amber{color:#1b1000; background:var(--warning); border-color:transparent}
.badge.mora{color:#fff; background:var(--mora); border-color:transparent}

.toolbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap;
}
.search-box{position:relative; display:flex; align-items:center; flex:1; max-width:400px}
.search-box input{
  background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:12px;
  padding:10px 12px; width:100%;
}

.ficha-header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap}
.ficha-titulos h2{margin:0; font-size:24px}
.saldo{margin:4px 0 0; color:var(--sub); font-weight:700; font-size:16px}

/* Alerta de mora en ficha */
.mora-banner{
  display:none;
  background:rgba(249,115,22,0.12);
  border:1px solid var(--mora);
  border-radius:12px;
  padding:12px 16px;
  margin-bottom:14px;
  font-size:14px;
  color:#ffdcc0;
}
.mora-banner.visible{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.mora-banner strong{color:var(--mora)}

.table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--panel)}
.table{width:100%; border-collapse:collapse; min-width:600px}
.table th, .table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
.table thead th{background:#0c1427; color:var(--sub); font-weight:600}
.table tbody tr:hover{background:#0c1427}
.table tbody tr:last-child td{border-bottom:0}
.table .num{text-align:right}
.table .btn-icon{padding:4px 8px; font-size:12px}

.grid{display:grid; gap:12px; grid-template-columns:1fr}
@media(min-width:600px){
  .grid{grid-template-columns:repeat(2, 1fr)}
}
.grid .full{grid-column:1/-1}
label{display:block}
label span{display:block; font-size:14px; color:var(--sub); margin-bottom:6px; font-weight:500}
input, select{
  width:100%; background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  font-family:inherit; font-size:14px;
}
input:focus, select:focus{outline:2px solid rgba(6,182,212,.3); border-color:var(--brand-2)}

.modal{border:0; padding:0; background:transparent; max-width:90vw}
.modal::backdrop{background:rgba(0,0,0,.7); backdrop-filter:blur(2px)}
.modal-content{
  background:var(--panel); color:var(--text);
  border:1px solid var(--border); border-radius:16px; 
  min-width:min(640px,90vw);
  padding:0; box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal-header{
  display:flex; align-items:center; justify-content:space-between; 
  padding:16px 20px; border-bottom:1px solid var(--border);
}
.modal-header h3{margin:0; font-size:18px}
.modal-actions{
  display:flex; gap:10px; justify-content:flex-end; 
  padding:16px 20px; background:#0c1427; border-top:1px solid var(--border);
  border-radius: 0 0 16px 16px;
}
.modal-body{padding:20px; max-height:70vh; overflow-y:auto}

/* ===== ESTILOS QUINIELA ===== */
.quiniela-layout{
  display:grid; 
  gap:16px;
  grid-template-columns: 1fr;
}
@media(min-width:900px){
  .quiniela-layout{grid-template-columns: 1fr 320px;}
}

.form-quiniela{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.form-quiniela h3{
  margin:0 0 16px;
  font-size:18px;
  display:flex;
  align-items:center;
  gap:8px;
}

.resumen-mensual{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.resumen-mensual h3{
  margin:0 0 16px;
  font-size:18px;
  display:flex;
  align-items:center;
  gap:8px;
}
.resumen-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid var(--border);
}
.resumen-item:last-child{border-bottom:0}
.resumen-label{color:var(--sub); font-size:14px}
.resumen-valor{font-weight:700; font-size:16px; color:var(--brand-2)}

.chart-container{
  margin-top:24px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.chart-container h3{
  margin:0 0 16px;
  font-size:18px;
}
.chart-wrapper{
  position:relative;
  height:350px;
}

.kpi-mini{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kpi-mini-label{
  font-size:11px;
  color:var(--sub);
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.kpi-mini-value{
  font-size:18px;
  font-weight:700;
  color:var(--text);
}

  </style>
</head>
<body>
  <!-- Login -->
  <div id="login" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <div class="logo">üé≤</div>
        <h1>El Esquinazo</h1>
        <p>Sistema de Gesti√≥n de Clientes</p>
      </div>
      <form id="form-login" class="grid">
        <label class="full">
          <span>Email</span>
          <input type="email" name="email" placeholder="info.esquinazo@gmail.com" required autofocus/>
        </label>
        <label class="full">
          <span>Contrase√±a</span>
          <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required/>
        </label>
        <button type="submit" class="btn primary full-width">Ingresar</button>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="main-app" hidden>
    <nav class="topbar">
      <div class="brand">
        <span class="logo">üé≤</span>
        <h1>El Esquinazo</h1>
      </div>
      <div class="user-info">
        <span class="user-email" id="user-email"></span>
        <button class="btn light" onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
    </nav>

    <nav class="topbar" style="top:auto">
      <div style="flex:1"></div>
      <div class="tabs">
        <button class="tab is-active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="clientes">Clientes</button>
        <button class="tab" data-tab="quiniela">Quiniela</button>
      </div>
    </nav>

    <main id="app">
      <!-- DASHBOARD -->
      <div id="dashboard" class="view is-active">
        <!-- KPIs: 6 columnas -->
        <div class="cards six-cols">
          <div class="card kpi">
            <h3>Fiado Total</h3>
            <div class="kpi-value danger" id="kpi-fiado">$ 0</div>
          </div>
          <div class="card kpi" style="cursor:pointer" onclick="filtrarClientesConDeuda()">
            <h3>Clientes con Deuda üëÜ</h3>
            <div class="kpi-value" id="kpi-condeuda">0</div>
          </div>
          <!-- NUEVA CARD: MORA +20 D√çAS -->
          <div class="card kpi mora-alert" style="cursor:pointer" onclick="filtrarMora20()">
            <h3>‚è∞ Mora +20 d√≠as üëÜ</h3>
            <div class="kpi-value mora" id="kpi-mora20">0</div>
          </div>
          <div class="card kpi" style="cursor:pointer" onclick="filtrarDeudasVencidas()">
            <h3>Deudas Vencidas üëÜ</h3>
            <div class="kpi-value danger" id="kpi-vencidas">0</div>
          </div>
          <div class="card kpi">
            <h3>Total Clientes</h3>
            <div class="kpi-value success" id="kpi-total-clientes">0</div>
          </div>
          <div class="card kpi">
            <h3>Clientes Nuevos</h3>
            <div class="kpi-value" id="kpi-clientes-nuevos">0</div>
          </div>
        </div>

        <section class="section">
          <h3>Acciones R√°pidas</h3>
          <button class="btn primary" id="btn-nuevo-cliente-rapido">+ A√±adir Cliente</button>
        </section>

        <!-- NUEVA SECCI√ìN: MORA +20 D√çAS -->
        <section class="section" id="seccion-mora20">
          <h3 style="color:var(--mora)">‚è∞ Clientes en Mora (+20 d√≠as)</h3>
          <div class="list" id="lista-mora20"></div>
        </section>

        <section class="section">
          <h3>Deudas Vencidas</h3>
          <div class="list" id="lista-vencidas"></div>
        </section>
      </div>

      <!-- CLIENTES -->
      <div id="clientes" class="view">
        <div class="toolbar">
          <button class="btn light" id="volver-dashboard-clientes">‚Üê Volver</button>
          <div class="search-box">
            <input type="text" placeholder="üîç Buscar cliente..." id="buscar-clientes"/>
          </div>
          <button class="btn primary" id="btn-add-cliente">+ A√±adir Cliente</button>
        </div>
        <div class="list empty-hint" id="lista-clientes"></div>
      </div>

      <!-- QUINIELA -->
      <div id="quiniela" class="view">
        <div class="toolbar">
          <button class="btn light" id="volver-dashboard-quiniela">‚Üê Volver</button>
          <div style="display:flex; align-items:center; gap:12px;">
            <label style="display:flex; align-items:center; gap:8px; margin:0; color:var(--sub); font-size:14px;">
              <span>üìÖ Ver mes:</span>
              <input type="month" id="selector-mes-quiniela" style="padding:8px 12px; background:#0e162b; color:var(--text); border:1px solid var(--border); border-radius:10px; font-size:14px;"/>
            </label>
          </div>
        </div>
        
        <div class="cards five-cols">
          <div class="card kpi">
            <h3>üí∞ Ventas</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-ventas-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-ventas-mes">$ 0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>üé´ Tickets</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-tickets-hoy">0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-tickets-mes">0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>üèÜ Premios</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-premios-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-premios-mes">$ 0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>üí≥ D√©bitos</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-debitos-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-debitos-mes">$ 0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>üíµ Comisiones</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-comisiones-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-comisiones-mes">$ 0</div>
            </div>
          </div>
        </div>

        <div class="quiniela-layout" style="margin-top:24px">
          <div class="form-quiniela">
            <h3>üìÖ Cargar Datos Diarios</h3>
            <form id="form-quiniela" class="grid">
              <label class="full">
                <span>Fecha</span>
                <input type="date" name="fecha" required/>
              </label>
              <label>
                <span>üí∞ Ventas</span>
                <input type="number" name="ventas" placeholder="0" step="0.01" min="0" required/>
              </label>
              <label>
                <span>üé´ Cantidad de Tickets</span>
                <input type="number" name="tickets" placeholder="0" min="0" required/>
              </label>
              <label>
                <span>üèÜ Premios</span>
                <input type="number" name="premios" placeholder="0" step="0.01" min="0" required/>
              </label>
              <label>
                <span>üí≥ D√©bitos</span>
                <input type="number" name="debitos" placeholder="0" step="0.01" required/>
              </label>
              <label>
                <span>üíµ Comisiones</span>
                <input type="number" name="comisiones" placeholder="0" step="0.01" min="0" required/>
              </label>
              <div class="full">
                <button type="submit" class="btn primary full-width">Guardar</button>
              </div>
            </form>
          </div>

          <div class="resumen-mensual">
            <h3>üìä Resumen del Mes</h3>
            <div class="resumen-item">
              <span class="resumen-label">üí∞ Ventas</span>
              <span class="resumen-valor" id="resumen-ventas">$ 0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">üé´ Tickets</span>
              <span class="resumen-valor" id="resumen-tickets">0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">üèÜ Premios</span>
              <span class="resumen-valor" id="resumen-premios">$ 0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">üí≥ D√©bitos</span>
              <span class="resumen-valor" id="resumen-debitos">$ 0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">üíµ Comisiones</span>
              <span class="resumen-valor" id="resumen-comisiones">$ 0</span>
            </div>
            <div class="resumen-item" style="margin-top:12px; padding-top:12px; border-top:2px solid var(--border)">
              <span class="resumen-label" style="font-weight:700">D√≠as Cargados</span>
              <span class="resumen-valor" id="resumen-dias">0</span>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <h3>üìà Evoluci√≥n Mensual</h3>
          <div class="chart-wrapper">
            <canvas id="chart-quiniela"></canvas>
          </div>
        </div>

        <div class="section">
          <div class="actions-row">
            <button class="btn danger" onclick="cerrarMesQuiniela()">üîí Cerrar Mes</button>
            <button class="btn primary" onclick="abrirHistoricoMensual()">üìä Ver Hist√≥rico Mensual</button>
            <button class="btn primary" onclick="abrirComparacionMeses()">üìà Comparar Meses</button>
          </div>
        </div>
      </div>

      <!-- FICHA -->
      <div id="ficha" class="view">
        <div class="ficha-header">
          <div class="ficha-titulos">
            <h2 id="ficha-nombre">-</h2>
            <div class="saldo" id="ficha-saldo">-</div>
          </div>
          <div class="actions-row">
            <button class="btn light" id="volver-clientes">‚Üê Volver</button>
            <button class="btn" onclick="abrirEditarCliente(state.fichaClienteId)">Editar</button>
            <button class="btn warning" id="btn-compartir-ficha">üì§ Enviar Resumen</button>
            <button class="btn" id="btn-enviar-advertencia" style="background:#a855f7;border-color:#a855f7">‚ö†Ô∏è Enviar Advertencia</button>
            <!-- NUEVO BOT√ìN MORA -->
            <button class="btn mora" id="btn-interes-mora" style="display:none">üî¥ Inter√©s por Mora (15%)</button>
            <a class="btn success" id="btn-whatsapp" target="_blank" style="display:none">üí¨ WhatsApp</a>
          </div>
        </div>

        <!-- BANNER DE MORA (aparece autom√°ticamente si aplica) -->
        <div class="mora-banner" id="mora-banner">
          <span style="font-size:20px">‚è∞</span>
          <div>
            <strong id="mora-banner-texto">Esta deuda lleva m√°s de 20 d√≠as de atraso.</strong>
            <span style="margin-left:8px;color:var(--sub);font-size:13px">Pod√©s notificar al cliente con el bot√≥n üî¥</span>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn primary" id="btn-registrar-pago">üí∞ Registrar Pago</button>
          <button class="btn" id="btn-registrar-jugada">üé≤ Registrar Jugada</button>
        </div>

        <section class="section">
          <h3>Historial</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Descripci√≥n</th>
                  <th class="num">Debe</th>
                  <th class="num">Haber</th>
                  <th class="num">Saldo</th>
                  <th class="num">Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-historial"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <footer style="text-align:center; padding:24px; color:var(--muted); font-size:12px">
      El Esquinazo ¬© <span id="year"></span>
    </footer>
  </div>

  <!-- Modal Cliente -->
  <dialog class="modal" id="modal-cliente">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-cliente-titulo">Nuevo Cliente</h3>
      </div>
      <form id="form-cliente">
        <input type="hidden" name="id"/>
        <div class="modal-body">
          <div class="grid">
            <label class="full">
              <span>Nombre completo</span>
              <input type="text" name="nombre" required autofocus/>
            </label>
            <label class="full">
              <span>WhatsApp (sin +54 9)</span>
              <input type="tel" name="whatsapp" placeholder="3492123456"/>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal Movimiento -->
  <dialog class="modal" id="modal-mov">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-mov-titulo">Nuevo Movimiento</h3>
      </div>
      <form id="form-mov">
        <input type="hidden" name="clienteId"/>
        <input type="hidden" name="movId"/>
        <div class="modal-body">
          <div class="grid">
            <label>
              <span>Fecha</span>
              <input type="date" name="fecha" required/>
            </label>
            <label>
              <span>Tipo</span>
              <select name="tipo" required>
                <option value="jugada">Jugada</option>
                <option value="pago">Pago</option>
              </select>
            </label>
            <label class="full">
              <span>Descripci√≥n (opcional)</span>
              <input type="text" name="descripcion"/>
            </label>
            <label class="full">
              <span>Monto</span>
              <input type="number" name="monto" step="0.01" min="0" required/>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal Confirmaci√≥n -->
  <dialog class="modal" id="modal-confirm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmar acci√≥n</h3>
      </div>
      <form>
        <div class="modal-body">
          <p id="confirm-msg"></p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn danger">Eliminar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal Hist√≥rico Mensual -->
  <dialog class="modal" id="modal-historico" style="max-width:90vw">
    <div class="modal-content" style="min-width:min(900px,90vw)">
      <div class="modal-header">
        <h3>üìä Hist√≥rico Mensual - Quiniela</h3>
      </div>
      <div class="modal-body">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Mes</th>
                <th class="num">Ventas</th>
                <th class="num">Tickets</th>
                <th class="num">Premios</th>
                <th class="num">D√©bitos</th>
                <th class="num">Comisiones</th>
                <th class="num">D√≠as</th>
              </tr>
            </thead>
            <tbody id="tbody-historico"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <!-- Modal Comparaci√≥n de Meses -->
  <dialog class="modal" id="modal-comparacion" style="max-width:90vw">
    <div class="modal-content" style="min-width:min(900px,90vw)">
      <div class="modal-header">
        <h3>üìà Comparaci√≥n de Meses</h3>
      </div>
      <div class="modal-body">
        <div class="grid">
          <label>
            <span>Mes 1</span>
            <select id="select-mes1"></select>
          </label>
          <label>
            <span>Mes 2</span>
            <select id="select-mes2"></select>
          </label>
        </div>
        <button class="btn primary full-width" onclick="compararMeses()" style="margin-top:16px">üìä Generar Comparaci√≥n</button>
        <div class="chart-container" style="margin-top:24px">
          <canvas id="chart-comparacion"></canvas>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cerrar</button>
      </div>
    </div>
  </dialog>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuHOmx6K4_7ke85fdlrnQlOGAfMI7bQf4",
      authDomain: "el-esquinazo-9d73f.firebaseapp.com",
      projectId: "el-esquinazo-9d73f",
      storageBucket: "el-esquinazo-9d73f.firebasestorage.app",
      messagingSenderId: "546263167857",
      appId: "1:546263167857:web:c44e73f6c41e7b81403cd0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const state = {
      clientes: [],
      fichaClienteId: null,
      quinielaData: []
    };

    // Login
    $('#form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        $('#user-email').textContent = user.email;
        $('#login').setAttribute('hidden', '');
        $('#main-app').removeAttribute('hidden');
        await cargarDatos();
        await cargarQuinielaData();
        renderAll();
        renderQuiniela();
      } else {
        $('#login').removeAttribute('hidden');
        $('#main-app').setAttribute('hidden', '');
      }
    });

    window.logout = () => signOut(auth);

    async function cargarDatos() {
      const snap = await getDocs(collection(db, 'clientes'));
      state.clientes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function guardarCliente(c) {
      await setDoc(doc(db, 'clientes', c.id), c);
    }

    async function eliminarCliente(id) {
      await deleteDoc(doc(db, 'clientes', id));
    }

    async function cargarQuinielaData() {
      const snap = await getDocs(collection(db, 'quiniela'));
      state.quinielaData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function guardarQuinielaRegistro(registro) {
      await setDoc(doc(db, 'quiniela', registro.id), registro);
    }

    // Utilidades
    function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function todayISO() { return new Date().toISOString().split('T')[0]; }
    function fmtMoney(n) { return '$ ' + Number(n).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function fmtFecha(iso) {
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }
    function parseDate(iso) { return new Date(iso + 'T00:00:00'); }
    function sanitizePhone(tel) {
      let clean = tel.replace(/\D/g, '');
      if (clean.startsWith('549')) return clean;
      if (clean.startsWith('9')) return '54' + clean;
      return '549' + clean;
    }
    function saldoCliente(c) {
      return (c.movs || []).reduce((sum, m) => sum + (m.debe || 0) - (m.haber || 0), 0);
    }
    function diasVencimiento(c) {
      const movs = [...(c.movs || [])].filter(m => m.debe).sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
      if (!movs.length) return 0;
      const primerFiado = parseDate(movs[0].fecha);
      const hoy = new Date();
      return Math.floor((hoy - primerFiado) / (1000 * 60 * 60 * 24));
    }

    // ============================================================
    // NUEVA FUNCI√ìN: verificar si tiene mora de 20+ d√≠as
    // ============================================================
    function tieneMora20(c) {
      return saldoCliente(c) > 0 && diasVencimiento(c) >= 20;
    }

    // Renderizado Dashboard
    function renderDashboard() {
      const total = state.clientes.reduce((s, c) => s + saldoCliente(c), 0);
      const conDeuda = state.clientes.filter(c => saldoCliente(c) > 0).length;
      const vencidas = state.clientes.filter(c => saldoCliente(c) > 0 && diasVencimiento(c) > 30);

      // NUEVO: clientes con mora 20+ d√≠as
      const mora20 = state.clientes.filter(tieneMora20);

      $('#kpi-fiado').textContent = fmtMoney(total);
      $('#kpi-condeuda').textContent = conDeuda;
      $('#kpi-vencidas').textContent = vencidas.length;
      $('#kpi-mora20').textContent = mora20.length;

      // Efecto visual: si hay mora, la card pulsa
      const cardMora = $('#kpi-mora20').closest('.card');
      if (mora20.length > 0) {
        cardMora.classList.add('mora-alert');
      } else {
        cardMora.classList.remove('mora-alert');
      }

      // Nuevas cards
      $('#kpi-total-clientes').textContent = state.clientes.length;
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const clientesNuevos = state.clientes.filter(c => {
        if (!c.movs || !c.movs.length) return false;
        const primerMov = [...c.movs].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha))[0];
        return parseDate(primerMov.fecha) >= inicioMes;
      }).length;
      $('#kpi-clientes-nuevos').textContent = clientesNuevos;

      // --- Lista Mora 20 d√≠as ---
      const listaMora20 = $('#lista-mora20');
      listaMora20.innerHTML = '';
      if (!mora20.length) {
        listaMora20.innerHTML = '<div style="color:var(--muted); padding:12px">‚úÖ No hay clientes con mora de m√°s de 20 d√≠as</div>';
      } else {
        mora20.forEach(c => {
          const saldo = saldoCliente(c);
          const dias = diasVencimiento(c);
          const interes = saldo * 0.15;
          const total = saldo + interes;
          const div = document.createElement('div');
          div.className = 'item mora-item';
          div.innerHTML = `
            <div class="meta">
              <div class="title">${c.nombre}</div>
              <div class="sub">
                <span class="badge red">${fmtMoney(saldo)}</span>
                <span class="badge mora">‚è∞ ${dias} d√≠as</span>
                <span class="badge amber">+15% = ${fmtMoney(total)}</span>
              </div>
            </div>
            <div class="actions-row">
              <button class="btn mora" onclick="enviarInteresMora('${c.id}')">üî¥ Notificar</button>
              <button class="btn success" onclick="abrirFicha('${c.id}')">Ver Ficha</button>
            </div>
          `;
          listaMora20.appendChild(div);
        });
      }

      // --- Lista Vencidas (30+ d√≠as) ---
      const listaVencidas = $('#lista-vencidas');
      listaVencidas.innerHTML = '';
      if (!vencidas.length) {
        listaVencidas.innerHTML = '<div style="color:var(--muted); padding:12px">‚úÖ No hay deudas vencidas</div>';
      } else {
        vencidas.forEach(c => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="meta">
              <div class="title">${c.nombre}</div>
              <div class="sub">
                <span class="badge red">${fmtMoney(saldoCliente(c))}</span>
                <span class="badge amber">${diasVencimiento(c)} d√≠as</span>
              </div>
            </div>
            <div class="actions-row">
              <button class="btn success" onclick="abrirFicha('${c.id}')">Ver</button>
            </div>
          `;
          listaVencidas.appendChild(div);
        });
      }
    }

    function renderClientes(query = '') {
      const q = query.toLowerCase();
      const filtrados = state.clientes.filter(c => c.nombre.toLowerCase().includes(q));
      const lista = $('#lista-clientes');
      lista.innerHTML = '';
      filtrados.forEach(c => {
        const saldo = saldoCliente(c);
        const mora = tieneMora20(c);
        const div = document.createElement('div');
        div.className = 'item' + (mora ? ' mora-item' : '');
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              ${saldo > 0 ? `<span class="badge red">${fmtMoney(saldo)}</span>` : '<span class="badge">Al d√≠a</span>'}
              ${mora ? `<span class="badge mora">‚è∞ ${diasVencimiento(c)} d√≠as</span>` : ''}
            </div>
          </div>
          <div class="actions-row">
            <button class="btn" onclick="abrirFicha('${c.id}')">Ver</button>
            <button class="btn light" onclick="abrirEditarCliente('${c.id}')">‚úèÔ∏è</button>
            <button class="btn danger" onclick="confirmarEliminarCliente('${c.id}')">üóëÔ∏è</button>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    window.abrirFicha = function(id) {
      state.fichaClienteId = id;
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      
      $('#ficha-nombre').textContent = c.nombre;
      const saldo = saldoCliente(c);
      $('#ficha-saldo').textContent = `DEUDA: ${fmtMoney(saldo)}`;
      
      if (c.whatsapp) {
        const mensajeSimple = `Hola ${c.nombre}, te escribo de *El Esquinazo*.`;
        $('#btn-whatsapp').href = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensajeSimple)}`;
        $('#btn-whatsapp').style.display = 'inline-block';
      } else {
        $('#btn-whatsapp').style.display = 'none';
      }

      // ============================================================
      // NUEVA L√ìGICA: mostrar bot√≥n e banner de mora si aplica
      // ============================================================
      const dias = diasVencimiento(c);
      const btnMora = $('#btn-interes-mora');
      const banner = $('#mora-banner');

      if (tieneMora20(c)) {
        const interes = saldo * 0.15;
        const totalConInteres = saldo + interes;
        btnMora.style.display = 'inline-block';
        banner.classList.add('visible');
        $('#mora-banner-texto').textContent =
          `‚ö†Ô∏è Esta deuda lleva ${dias} d√≠as de atraso. Deuda: ${fmtMoney(saldo)} ‚Üí Con 15% de inter√©s: ${fmtMoney(totalConInteres)}`;
      } else {
        btnMora.style.display = 'none';
        banner.classList.remove('visible');
      }
      
      renderHistorial(c);
      switchView('ficha');
    };

    function renderHistorial(c) {
      const tbody = $('#tabla-historial');
      tbody.innerHTML = "";
      const movs = [...(c.movs || [])].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
      let saldo = 0;
      movs.forEach(m => {
        saldo += (m.debe || 0) - (m.haber || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtFecha(m.fecha)}</td>
          <td>${m.descripcion || "-"}</td>
          <td class="num">${m.debe ? fmtMoney(m.debe) : "-"}</td>
          <td class="num">${m.haber ? fmtMoney(m.haber) : "-"}</td>
          <td class="num"><strong>${fmtMoney(saldo)}</strong></td>
          <td class="num">
            <button class="btn btn-icon light" onclick="abrirEditarMov('${c.id}','${m.id}')">‚úèÔ∏è</button>
            <button class="btn btn-icon danger" onclick="confirmarEliminarMov('${c.id}','${m.id}')">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function switchView(id) {
      $$('.view').forEach(v => {
        v.classList.remove('is-active');
        v.setAttribute('hidden', '');
      });
      const view = $('#'+id);
      view.classList.add('is-active');
      view.removeAttribute('hidden');
      
      $$('.tab').forEach(t => t.classList.remove('is-active'));
      const tab = $(`.tab[data-tab="${id}"]`);
      if (tab) tab.classList.add('is-active');
    }

    // Modales Cliente
    window.abrirNuevoCliente = function() {
      $('#form-cliente').reset();
      $('#form-cliente').id.value = '';
      $('#modal-cliente-titulo').textContent = 'Nuevo Cliente';
      $('#modal-cliente').showModal();
    };

    window.abrirEditarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#form-cliente').reset();
      $('#form-cliente').id.value = c.id;
      $('#form-cliente').nombre.value = c.nombre;
      $('#form-cliente').whatsapp.value = (c.whatsapp || "").replace(/^549/, "");
      $('#modal-cliente-titulo').textContent = 'Editar Cliente';
      $('#modal-cliente').showModal();
    };

    $('#form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = $('#form-cliente').id.value || uid();
      const nombre = $('#form-cliente').nombre.value.trim();
      const whatsapp = sanitizePhone($('#form-cliente').whatsapp.value);
      if (!nombre) return;

      const idx = state.clientes.findIndex(x => x.id === id);
      if (idx >= 0) {
        state.clientes[idx].nombre = nombre;
        state.clientes[idx].whatsapp = whatsapp;
        await guardarCliente(state.clientes[idx]);
      } else {
        const nuevo = { id, nombre, whatsapp, movs: [] };
        state.clientes.push(nuevo);
        await guardarCliente(nuevo);
      }
      $('#modal-cliente').close();
      renderAll();
    });

    window.confirmarEliminarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#confirm-msg').textContent = `¬øEliminar a "${c.nombre}" y todo su historial?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async (e) => {
        e.preventDefault();
        state.clientes = state.clientes.filter(x => x.id !== id);
        await eliminarCliente(id);
        $('#modal-confirm').close();
        if (state.fichaClienteId === id) {
          state.fichaClienteId = null;
          switchView('clientes');
        }
        renderAll();
      };
    };

    // Modales Movimiento
    window.abrirNuevoMov = function(tipo) {
      $('#form-mov').reset();
      $('#form-mov').fecha.value = todayISO();
      $('#form-mov').tipo.value = tipo;
      $('#form-mov').clienteId.value = state.fichaClienteId;
      $('#form-mov').movId.value = '';
      $('#modal-mov-titulo').textContent = tipo === 'pago' ? 'Registrar Pago' : 'Registrar Jugada';
      $('#modal-mov').showModal();
    };

    window.abrirEditarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#form-mov').reset();
      $('#form-mov').fecha.value = m.fecha;
      $('#form-mov').tipo.value = m.tipo;
      $('#form-mov').descripcion.value = m.descripcion || '';
      $('#form-mov').monto.value = m.tipo === 'jugada' ? m.debe : m.haber;
      $('#form-mov').clienteId.value = clienteId;
      $('#form-mov').movId.value = movId;
      $('#modal-mov-titulo').textContent = 'Editar Movimiento';
      $('#modal-mov').showModal();
    };

    $('#form-mov').addEventListener('submit', async (e) => {
      e.preventDefault();
      const clienteId = $('#form-mov').clienteId.value;
      const movId = $('#form-mov').movId.value;
      const c = state.clientes.find(x => x.id === clienteId);
      if (!c) return;

      const tipo = $('#form-mov').tipo.value;
      const fecha = $('#form-mov').fecha.value;
      const descripcion = $('#form-mov').descripcion.value.trim();
      const monto = Math.max(0, Number($('#form-mov').monto.value || 0));

      if (!fecha || !monto) return;

      if (movId) {
        const mov = c.movs.find(x => x.id === movId);
        if (mov) {
          mov.fecha = fecha;
          mov.tipo = tipo;
          mov.descripcion = descripcion;
          mov.debe = tipo === 'jugada' ? monto : 0;
          mov.haber = tipo === 'pago' ? monto : 0;
        }
      } else {
        c.movs.push({
          id: uid(),
          fecha,
          tipo,
          descripcion,
          debe: tipo === 'jugada' ? monto : 0,
          haber: tipo === 'pago' ? monto : 0,
        });
      }

      await guardarCliente(c);
      $('#modal-mov').close();
      if (state.fichaClienteId === clienteId) renderHistorial(c);
      renderAll();
    });

    window.confirmarEliminarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#confirm-msg').textContent = `¬øEliminar el movimiento "${m.descripcion || m.tipo}"?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async (e) => {
        e.preventDefault();
        c.movs = c.movs.filter(x => x.id !== movId);
        await guardarCliente(c);
        $('#modal-confirm').close();
        renderHistorial(c);
        renderAll();
      };
    };

    // ============================================================
    // NUEVA FUNCI√ìN: Enviar mensaje de inter√©s por mora (15%)
    // Puede llamarse desde la ficha o desde el dashboard
    // ============================================================
    window.enviarInteresMora = function(clienteId) {
      const id = clienteId || state.fichaClienteId;
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;

      if (!c.whatsapp) {
        alert('‚ö†Ô∏è Este cliente no tiene WhatsApp configurado.\n\nPod√©s agregarlo editando el cliente.');
        return;
      }

      const saldo = saldoCliente(c);
      const dias = diasVencimiento(c);
      const interes = saldo * 0.15;
      const totalConInteres = saldo + interes;

      const mensaje =
        `Hola *${c.nombre}*,\n\n` +
        `Le informamos desde *El Esquinazo* que su deuda de *${fmtMoney(saldo)}* lleva *${dias} d√≠as de atraso*.\n\n` +
        `‚ö†Ô∏è Por retraso mayor a 20 d√≠as, se aplica un recargo del *15% de inter√©s por mora*.\n\n` +
        `üìä *Detalle:*\n` +
        `‚Ä¢ Deuda original: ${fmtMoney(saldo)}\n` +
        `‚Ä¢ Inter√©s por mora (15%): ${fmtMoney(interes)}\n` +
        `‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
        `‚Ä¢ *Total a pagar: ${fmtMoney(totalConInteres)}*\n\n` +
        `Por favor, regularice su situaci√≥n a la brevedad.\n\n` +
        `¬°Muchas gracias! üôè`;

      const url = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    // Quiniela
    $('#form-quiniela').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fecha = $('#form-quiniela').fecha.value;
      const ventas = Number($('#form-quiniela').ventas.value || 0);
      const tickets = Number($('#form-quiniela').tickets.value || 0);
      const premios = Number($('#form-quiniela').premios.value || 0);
      const debitos = Number($('#form-quiniela').debitos.value || 0);
      const comisiones = Number($('#form-quiniela').comisiones.value || 0);

      if (!fecha) return;

      const id = fecha;
      const registro = { id, fecha, ventas, tickets, premios, debitos, comisiones };

      await guardarQuinielaRegistro(registro);
      
      const idx = state.quinielaData.findIndex(x => x.id === id);
      if (idx >= 0) {
        state.quinielaData[idx] = registro;
      } else {
        state.quinielaData.push(registro);
      }

      $('#form-quiniela').reset();
      $('#form-quiniela').fecha.value = todayISO();
      
      renderQuiniela();
      alert('‚úÖ Datos guardados correctamente');
    });

    function renderQuiniela() {
      const hoy = todayISO();
      
      const selectorMes = $('#selector-mes-quiniela');
      if (!selectorMes.value) {
        const fechaHoy = new Date();
        const a√±o = fechaHoy.getFullYear();
        const mes = String(fechaHoy.getMonth() + 1).padStart(2, '0');
        selectorMes.value = `${a√±o}-${mes}`;
      }
      
      const mesSeleccionado = selectorMes.value;
      const [a√±oSel, mesSel] = mesSeleccionado.split('-').map(Number);

      const datosMes = state.quinielaData.filter(d => {
        const fecha = new Date(d.fecha + 'T00:00:00');
        return fecha.getFullYear() === a√±oSel && fecha.getMonth() === (mesSel - 1);
      });

      const totalesMes = datosMes.reduce((acc, d) => ({
        ventas: acc.ventas + d.ventas,
        tickets: acc.tickets + d.tickets,
        premios: acc.premios + (d.premios || 0),
        debitos: acc.debitos + d.debitos,
        comisiones: acc.comisiones + d.comisiones
      }), { ventas: 0, tickets: 0, premios: 0, debitos: 0, comisiones: 0 });

      const esMesActual = mesSeleccionado === `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
      const datosHoy = esMesActual 
        ? (state.quinielaData.find(d => d.fecha === hoy) || { ventas: 0, tickets: 0, premios: 0, debitos: 0, comisiones: 0 })
        : { ventas: 0, tickets: 0, premios: 0, debitos: 0, comisiones: 0 };

      $('#quiniela-ventas-hoy').textContent = fmtMoney(datosHoy.ventas);
      $('#quiniela-ventas-mes').textContent = fmtMoney(totalesMes.ventas);
      $('#quiniela-tickets-hoy').textContent = datosHoy.tickets;
      $('#quiniela-tickets-mes').textContent = totalesMes.tickets;
      $('#quiniela-premios-hoy').textContent = fmtMoney(datosHoy.premios || 0);
      $('#quiniela-premios-mes').textContent = fmtMoney(totalesMes.premios);
      $('#quiniela-debitos-hoy').textContent = fmtMoney(datosHoy.debitos);
      $('#quiniela-debitos-mes').textContent = fmtMoney(totalesMes.debitos);
      $('#quiniela-comisiones-hoy').textContent = fmtMoney(datosHoy.comisiones);
      $('#quiniela-comisiones-mes').textContent = fmtMoney(totalesMes.comisiones);

      $('#resumen-ventas').textContent = fmtMoney(totalesMes.ventas);
      $('#resumen-tickets').textContent = totalesMes.tickets;
      $('#resumen-premios').textContent = fmtMoney(totalesMes.premios);
      $('#resumen-debitos').textContent = fmtMoney(totalesMes.debitos);
      $('#resumen-comisiones').textContent = fmtMoney(totalesMes.comisiones);
      $('#resumen-dias').textContent = datosMes.length;

      renderGraficoQuiniela(datosMes);

      if (!$('#form-quiniela').fecha.value) {
        $('#form-quiniela').fecha.value = hoy;
      }
    }

    let chartQuiniela = null;
    function renderGraficoQuiniela(datos) {
      const datosOrdenados = [...datos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

      const labels = datosOrdenados.map(d => {
        const fecha = new Date(d.fecha + 'T00:00:00');
        return `${fecha.getDate()}/${fecha.getMonth() + 1}`;
      });

      const datasets = [
        {
          label: 'Ventas',
          data: datosOrdenados.map(d => d.ventas),
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          tension: 0.3
        },
        {
          label: 'D√©bitos',
          data: datosOrdenados.map(d => d.debitos),
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          tension: 0.3
        },
        {
          label: 'Premios',
          data: datosOrdenados.map(d => d.premios || 0),
          borderColor: '#a855f7',
          backgroundColor: 'rgba(168, 85, 247, 0.1)',
          tension: 0.3
        },
        {
          label: 'Comisiones',
          data: datosOrdenados.map(d => d.comisiones),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.3
        },
        {
          label: 'Tickets',
          data: datosOrdenados.map(d => d.tickets),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.3,
          yAxisID: 'y1'
        }
      ];

      const ctx = $('#chart-quiniela');
      if (chartQuiniela) { chartQuiniela.destroy(); }

      chartQuiniela = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#cbd5e1', font: { size: 12 } } },
            tooltip: {
              backgroundColor: '#111827',
              titleColor: '#e5e7eb',
              bodyColor: '#cbd5e1',
              borderColor: '#1f2937',
              borderWidth: 1
            }
          },
          scales: {
            x: { grid: { color: '#1f2937' }, ticks: { color: '#cbd5e1' } },
            y: {
              type: 'linear',
              position: 'left',
              grid: { color: '#1f2937' },
              ticks: { color: '#cbd5e1', callback: v => '$ ' + v.toLocaleString('es-AR') }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { display: false },
              ticks: { color: '#cbd5e1' }
            }
          }
        }
      });
    }

    // Eventos
    $$('.tab').forEach(btn => btn.addEventListener('click', () => {
      switchView(btn.dataset.tab);
      if (btn.dataset.tab === 'quiniela') renderQuiniela();
      if (btn.dataset.tab === 'clientes') {
        $('#buscar-clientes').value = '';
        renderClientes('');
      }
    }));
    $('#btn-nuevo-cliente-rapido').addEventListener('click', abrirNuevoCliente);
    $('#btn-add-cliente').addEventListener('click', abrirNuevoCliente);
    $('#buscar-clientes').addEventListener('input', (e) => renderClientes(e.target.value));
    $('#selector-mes-quiniela').addEventListener('change', () => renderQuiniela());
    $('#volver-dashboard-clientes').addEventListener('click', () => switchView('dashboard'));
    $('#volver-dashboard-quiniela').addEventListener('click', () => switchView('dashboard'));
    $('#volver-clientes').addEventListener('click', () => {
      $('#buscar-clientes').value = '';
      renderClientes('');
      switchView('clientes');
    });
    $('#btn-registrar-pago').addEventListener('click', () => abrirNuevoMov('pago'));
    $('#btn-registrar-jugada').addEventListener('click', () => abrirNuevoMov('jugada'));
    $('#btn-compartir-ficha').addEventListener('click', compartirFicha);
    $('#btn-enviar-advertencia').addEventListener('click', enviarAdvertencia);

    // NUEVO: evento del bot√≥n mora en la ficha
    $('#btn-interes-mora').addEventListener('click', () => enviarInteresMora(state.fichaClienteId));

    $('#year').textContent = new Date().getFullYear();

    function compartirFicha() {
      const c = state.clientes.find(x => x.id === state.fichaClienteId);
      if (!c) return;
      if (!c.whatsapp) {
        alert('‚ö†Ô∏è Este cliente no tiene WhatsApp configurado.\n\nPuedes agregarlo editando el cliente.');
        return;
      }
      const saldo = saldoCliente(c);
      const movs = [...(c.movs || [])].sort((a, b) => parseDate(b.fecha) - parseDate(a.fecha));
      const ultimos = movs.slice(0, 10);
      let resumen = ultimos.map(m => {
        const tipo = m.tipo === 'jugada' ? 'üé≤ Jugada' : 'üí∞ Pago';
        const monto = m.tipo === 'jugada' ? fmtMoney(m.debe) : fmtMoney(m.haber);
        const desc = m.descripcion ? ` - ${m.descripcion}` : '';
        return `${fmtFecha(m.fecha)}: ${tipo}${desc} ${monto}`;
      }).join('\n');
      const mensaje = `Hola *${c.nombre}*,\n\nTe env√≠o el resumen de tu cuenta de *El Esquinazo*:\n\n${resumen}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n*SALDO ACTUAL: ${fmtMoney(saldo)}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${saldo > 0 ? '‚ö†Ô∏è Por favor coordina el pago lo antes posible.' : '‚úÖ Tu cuenta est√° al d√≠a.'}\n\n¬°Gracias!`;
      const url = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    function enviarAdvertencia() {
      const c = state.clientes.find(x => x.id === state.fichaClienteId);
      if (!c) return;
      if (!c.whatsapp) {
        alert('‚ö†Ô∏è Este cliente no tiene WhatsApp configurado.\n\nPuedes agregarlo editando el cliente.');
        return;
      }
      const mensaje = `Hola *${c.nombre}* !\nTe informamos que tu cuenta corriente ha alcanzado el l√≠mite de saldo disponible. Te solicitamos comunicarte con la Agencia a la brevedad.\nMuchas gracias.`;
      const url = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    function renderAll() {
      renderDashboard();
      renderClientes($('#buscar-clientes').value || '');
    }

    window.filtrarClientesConDeuda = function() {
      switchView('clientes');
      const clientesConDeuda = state.clientes.filter(c => saldoCliente(c) > 0);
      const lista = $('#lista-clientes');
      lista.innerHTML = '';
      if (!clientesConDeuda.length) {
        lista.innerHTML = '<div style="color:var(--muted); padding:12px">‚úÖ No hay clientes con deuda</div>';
        return;
      }
      clientesConDeuda.forEach(c => {
        const saldo = saldoCliente(c);
        const mora = tieneMora20(c);
        const div = document.createElement('div');
        div.className = 'item' + (mora ? ' mora-item' : '');
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              <span class="badge red">${fmtMoney(saldo)}</span>
              ${mora ? `<span class="badge mora">‚è∞ ${diasVencimiento(c)} d√≠as</span>` : ''}
            </div>
          </div>
          <div class="actions-row">
            <button class="btn" onclick="abrirFicha('${c.id}')">Ver</button>
            <button class="btn light" onclick="abrirEditarCliente('${c.id}')">‚úèÔ∏è</button>
            <button class="btn danger" onclick="confirmarEliminarCliente('${c.id}')">üóëÔ∏è</button>
          </div>
        `;
        lista.appendChild(div);
      });
      $('#buscar-clientes').value = '';
    };

    window.filtrarDeudasVencidas = function() {
      switchView('clientes');
      const vencidas = state.clientes.filter(c => saldoCliente(c) > 0 && diasVencimiento(c) > 30);
      const lista = $('#lista-clientes');
      lista.innerHTML = '';
      if (!vencidas.length) {
        lista.innerHTML = '<div style="color:var(--muted); padding:12px">‚úÖ No hay deudas vencidas</div>';
        return;
      }
      vencidas.forEach(c => {
        const saldo = saldoCliente(c);
        const dias = diasVencimiento(c);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              <span class="badge red">${fmtMoney(saldo)}</span>
              <span class="badge amber">${dias} d√≠as</span>
            </div>
          </div>
          <div class="actions-row">
            <button class="btn" onclick="abrirFicha('${c.id}')">Ver</button>
            <button class="btn light" onclick="abrirEditarCliente('${c.id}')">‚úèÔ∏è</button>
            <button class="btn danger" onclick="confirmarEliminarCliente('${c.id}')">üóëÔ∏è</button>
          </div>
        `;
        lista.appendChild(div);
      });
      $('#buscar-clientes').value = '';
    };

    // NUEVO: filtrar clientes con mora 20+ d√≠as desde la card del dashboard
    window.filtrarMora20 = function() {
      switchView('clientes');
      const mora20 = state.clientes.filter(tieneMora20);
      const lista = $('#lista-clientes');
      lista.innerHTML = '';
      if (!mora20.length) {
        lista.innerHTML = '<div style="color:var(--muted); padding:12px">‚úÖ No hay clientes con mora de m√°s de 20 d√≠as</div>';
        return;
      }
      mora20.forEach(c => {
        const saldo = saldoCliente(c);
        const dias = diasVencimiento(c);
        const interes = saldo * 0.15;
        const totalConInteres = saldo + interes;
        const div = document.createElement('div');
        div.className = 'item mora-item';
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              <span class="badge red">${fmtMoney(saldo)}</span>
              <span class="badge mora">‚è∞ ${dias} d√≠as</span>
              <span class="badge amber">Con inter√©s: ${fmtMoney(totalConInteres)}</span>
            </div>
          </div>
          <div class="actions-row">
            <button class="btn mora" onclick="enviarInteresMora('${c.id}')">üî¥ Notificar</button>
            <button class="btn" onclick="abrirFicha('${c.id}')">Ver Ficha</button>
          </div>
        `;
        lista.appendChild(div);
      });
      $('#buscar-clientes').value = '';
    };

    // Quiniela: Cerrar Mes
    window.cerrarMesQuiniela = async function() {
      const mesSeleccionado = $('#selector-mes-quiniela').value;
      if (!mesSeleccionado) { alert('‚ö†Ô∏è Selecciona un mes para cerrar'); return; }
      const mesesCerrados = JSON.parse(localStorage.getItem('quiniela_meses_cerrados') || '{}');
      if (mesesCerrados[mesSeleccionado]) { alert('‚ö†Ô∏è Este mes ya fue cerrado anteriormente'); return; }
      if (!confirm(`¬øCerrar el mes ${formatearMes(mesSeleccionado)}?\n\nEsto guardar√° los datos actuales como hist√≥rico.`)) return;
      
      let ventasMes = 0, ticketsMes = 0, premiosMes = 0, debitosMes = 0, comisionesMes = 0, diasRegistrados = 0;
      state.quinielaData.forEach(r => {
        if (r.fecha.startsWith(mesSeleccionado)) {
          ventasMes += r.ventas || 0;
          ticketsMes += r.tickets || 0;
          premiosMes += r.premios || 0;
          debitosMes += r.debitos || 0;
          comisionesMes += r.comisiones || 0;
          diasRegistrados++;
        }
      });
      if (!diasRegistrados) { alert('‚ö†Ô∏è No hay datos registrados para este mes'); return; }
      
      mesesCerrados[mesSeleccionado] = { mes: mesSeleccionado, ventas: ventasMes, tickets: ticketsMes, premios: premiosMes, debitos: debitosMes, comisiones: comisionesMes, diasRegistrados, fechaCierre: new Date().toISOString() };
      localStorage.setItem('quiniela_meses_cerrados', JSON.stringify(mesesCerrados));
      alert(`‚úÖ Mes ${formatearMes(mesSeleccionado)} cerrado correctamente\n\nVentas: ${fmtMoney(ventasMes)}\nTickets: ${ticketsMes}\nPremios: ${fmtMoney(premiosMes)}\nD√©bitos: ${fmtMoney(debitosMes)}\nComisiones: ${fmtMoney(comisionesMes)}\nD√≠as: ${diasRegistrados}`);
    };

    window.abrirHistoricoMensual = function() {
      const tbody = $('#tbody-historico');
      const mesesCerrados = JSON.parse(localStorage.getItem('quiniela_meses_cerrados') || '{}');
      const mesesArray = Object.values(mesesCerrados).sort((a,b) => b.mes.localeCompare(a.mes));
      tbody.innerHTML = !mesesArray.length
        ? '<tr><td colspan="7" style="text-align:center;color:var(--sub);padding:24px">No hay meses cerrados a√∫n</td></tr>'
        : mesesArray.map(mes => `
            <tr>
              <td style="font-weight:700;color:var(--brand-2)">${formatearMes(mes.mes)}</td>
              <td class="num">${fmtMoney(mes.ventas)}</td>
              <td class="num">${mes.tickets}</td>
              <td class="num">${fmtMoney(mes.premios || 0)}</td>
              <td class="num">${fmtMoney(mes.debitos)}</td>
              <td class="num">${fmtMoney(mes.comisiones)}</td>
              <td class="num">${mes.diasRegistrados}</td>
            </tr>`).join('');
      $('#modal-historico').showModal();
    };

    window.abrirComparacionMeses = function() {
      const mesesCerrados = JSON.parse(localStorage.getItem('quiniela_meses_cerrados') || '{}');
      const mesesArray = Object.keys(mesesCerrados).sort((a,b) => b.localeCompare(a));
      if (mesesArray.length < 2) { alert('‚ö†Ô∏è Necesitas al menos 2 meses cerrados para comparar'); return; }
      const options = mesesArray.map(mes => `<option value="${mes}">${formatearMes(mes)}</option>`).join('');
      $('#select-mes1').innerHTML = options;
      $('#select-mes2').innerHTML = options;
      if (mesesArray.length >= 2) $('#select-mes2').selectedIndex = 1;
      $('#modal-comparacion').showModal();
    };

    let chartComparacion = null;
    window.compararMeses = function() {
      const mes1 = $('#select-mes1').value;
      const mes2 = $('#select-mes2').value;
      if (mes1 === mes2) { alert('‚ö†Ô∏è Selecciona dos meses diferentes'); return; }
      const mesesCerrados = JSON.parse(localStorage.getItem('quiniela_meses_cerrados') || '{}');
      const datos1 = mesesCerrados[mes1];
      const datos2 = mesesCerrados[mes2];
      if (chartComparacion) chartComparacion.destroy();
      chartComparacion = new Chart($('#chart-comparacion'), {
        type: 'bar',
        data: {
          labels: ['Ventas', 'Tickets', 'Premios', 'D√©bitos', 'Comisiones'],
          datasets: [
            { label: formatearMes(mes1), data: [datos1.ventas, datos1.tickets, datos1.premios||0, datos1.debitos, datos1.comisiones], backgroundColor: '#22c55e' },
            { label: formatearMes(mes2), data: [datos2.ventas, datos2.tickets, datos2.premios||0, datos2.debitos, datos2.comisiones], backgroundColor: '#06b6d4' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#cbd5e1' } },
            tooltip: { backgroundColor: '#111827', titleColor: '#e5e7eb', bodyColor: '#cbd5e1', borderColor: '#1f2937', borderWidth: 1 }
          },
          scales: {
            x: { grid: { color: '#1f2937' }, ticks: { color: '#cbd5e1' } },
            y: { grid: { color: '#1f2937' }, ticks: { color: '#cbd5e1', callback: v => v.toLocaleString('es-AR') } }
          }
        }
      });
    };

    function formatearMes(mesStr) {
      const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
      const [year, month] = mesStr.split('-');
      return `${meses[parseInt(month)-1]} ${year}`;
    }

    console.log("üé≤ El Esquinazo 5.8 ‚Äì Mora 20 d√≠as + Inter√©s 15% activo");
  </script>
</body>
</html>
