<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Sistema de gesti√≥n de clientes para El Esquinazo" />
  <meta name="theme-color" content="#0f172a" />
  <title>El Esquinazo ‚Äì Gesti√≥n de Clientes</title>
  
  <!-- PWA -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkVsIEVzcXVpbmF6byIsCiAgInNob3J0X25hbWUiOiAiRXNxdWluYXpvIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGYxNzJhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0Xwn46yJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==" />
  
  <style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --muted:#334155;
  --text:#e5e7eb;
  --sub:#cbd5e1;
  --brand:#22c55e;
  --brand-2:#06b6d4;
  --danger:#ef4444;
  --warning:#f59e0b;
  --ok:#10b981;
  --card:#0b1224;
  --border:#1f2937;
  --shadow: 0 6px 24px rgba(0,0,0,.35);
  --radius:16px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  background: linear-gradient(180deg,var(--bg),#0b1224 60%);
  color:var(--text);
}

.topbar{
  position:sticky; top:0; z-index:10;
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:12px 16px;
  background:rgba(15,23,42,.95);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{display:flex; align-items:center; gap:10px}
.brand .logo{font-size:22px}
.brand h1{font-size:18px; margin:0}

.tabs{display:flex; gap:8px}
.tab{
  background:transparent;
  border:1px solid var(--border);
  color:var(--sub);
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  transition: all .2s;
}
.tab:hover{background:rgba(255,255,255,.05)}
.tab.is-active{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:600}

main#app{padding:16px; max-width:1100px; margin-inline:auto; min-height: calc(100vh - 180px)}
.view{display:none}
.view.is-active{display:block}

.cards{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
}
@media(min-width:720px){
  .cards{grid-template-columns: repeat(3, 1fr);}
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow: var(--shadow);
}
.kpi h3{margin:0 0 6px; color:var(--sub); font-weight:500; font-size:14px}
.kpi-value{font-size:28px; margin:4px 0 0; font-weight:800; color:var(--brand-2)}
.kpi-value.danger{color:var(--danger)}
.kpi-value.ok{color:var(--ok)}

.section{margin-top:22px}
.section h3{margin:0 0 10px; font-size:18px}

.btn{
  background:#121b31;
  color:var(--text);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:.2s all ease;
  font-size:14px;
  font-weight:500;
}
.btn:hover{transform:translateY(-1px); border-color:#2b3b55; box-shadow: 0 4px 12px rgba(0,0,0,.3)}
.btn:active{transform:translateY(0)}
.btn.primary{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:700}
.btn.success{background:var(--ok); color:#00170f; border-color:transparent; font-weight:700; text-decoration:none; display:inline-block}
.btn.outline{background:transparent}
.btn.light{background:transparent; color:var(--sub)}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.btn.warning{background:var(--warning); color:#1b1000; border-color:transparent; font-weight:700}
.btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

.icon-btn{
  background:transparent; border:0; color:var(--sub); font-size:24px; line-height:1; cursor:pointer;
  padding:4px 8px; transition: color .2s;
}
.icon-btn:hover{color:var(--text)}

.actions-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}

.list{display:grid; gap:10px}
.empty-hint:empty::after{
  content:"Sin elementos para mostrar.";
  color:var(--muted);
  padding:12px 16px;
  background:rgba(255,255,255,0.02);
  border:1px dashed var(--border);
  border-radius:12px;
  display:block;
}

.item{
  display:flex; gap:12px; justify-content:space-between; align-items:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  transition: border-color .2s;
}
.item:hover{border-color:var(--muted)}
.item .meta{display:flex; flex-direction:column; gap:4px; flex:1}
.item .title{font-weight:700; font-size:16px}
.item .sub{display:flex; gap:6px; flex-wrap:wrap; align-items:center}
.badge{
  padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
  border:1px solid var(--border); color:var(--sub); background:#0e162b;
}
.badge.red{color:#fff; background:var(--danger); border-color:transparent}
.badge.amber{color:#1b1000; background:var(--warning); border-color:transparent}
.badge.green{color:#00170f; background:var(--ok); border-color:transparent}

.toolbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap;
}
.search-box{
  position:relative; display:flex; align-items:center;
}
.search-box input{
  background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:12px;
  padding:10px 34px 10px 12px; min-width:240px;
}
.search-box input:focus{outline:2px solid rgba(6,182,212,.3); border-color:var(--brand-2)}
.kbd{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  border:1px solid var(--border); padding:2px 6px; border-radius:6px; font-size:12px; color:var(--sub);
  pointer-events:none;
}

.ficha-header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap}
.ficha-titulos{flex:1}
.ficha-titulos h2{margin:0; font-size:24px}
.saldo{margin:4px 0 0; color:var(--sub); font-weight:700; font-size:16px}

.table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--panel)}
.table{width:100%; border-collapse:collapse; min-width:600px}
.table th, .table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
.table thead th{background:#0c1427; color:var(--sub); font-weight:600; position:sticky; top:0}
.table tbody tr:hover{background:#0c1427}
.table tbody tr:last-child td{border-bottom:0}
.table .num{text-align:right; font-variant-numeric: tabular-nums}
.table .actions{display:flex; gap:6px; justify-content:flex-end}
.table .btn-icon{
  padding:4px 8px; font-size:12px; border-radius:6px;
}

.grid{display:grid; gap:12px; grid-template-columns:1fr}
@media(min-width:600px){
  .grid{grid-template-columns:repeat(2, 1fr)}
}
.grid .full{grid-column:1/-1}
label{display:block}
label span{display:block; font-size:14px; color:var(--sub); margin-bottom:6px; font-weight:500}
input, select, textarea{
  width:100%; background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  font-family:inherit; font-size:14px;
}
input:focus, select:focus, textarea:focus{outline:2px solid rgba(6,182,212,.3); border-color:var(--brand-2)}
textarea{resize:vertical; min-height:80px}

.modal{border:0; padding:0; background:transparent; max-width:90vw}
.modal::backdrop{background:rgba(0,0,0,.7); backdrop-filter:blur(2px)}
.modal-content{
  background:var(--panel); color:var(--text);
  border:1px solid var(--border); border-radius:16px; 
  min-width:min(640px,90vw);
  padding:0; box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal-header{
  display:flex; align-items:center; justify-content:space-between; 
  padding:16px 20px; border-bottom:1px solid var(--border);
}
.modal-header h3{margin:0; font-size:18px}
.modal-actions{
  display:flex; gap:10px; justify-content:flex-end; 
  padding:16px 20px; border-top:1px solid var(--border);
}
.modal-content .grid, .modal-content p{padding:20px}

.alert{
  padding:12px 16px; border-radius:12px; margin:16px 0;
  border:1px solid var(--border); background:rgba(34,197,94,.1);
  color:var(--text); font-size:14px;
}
.alert.warning{background:rgba(245,158,11,.1); border-color:var(--warning)}
.alert.danger{background:rgba(239,68,68,.1); border-color:var(--danger)}

.footer{padding:24px 16px; text-align:center; color:var(--muted); font-size:13px; border-top:1px solid var(--border); margin-top:40px}

.stats-grid{
  display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  margin-top:16px;
}
.stat-item{
  background:rgba(255,255,255,.03); border:1px solid var(--border);
  border-radius:12px; padding:12px;
}
.stat-label{font-size:12px; color:var(--sub); margin-bottom:4px}
.stat-value{font-size:20px; font-weight:700; color:var(--brand-2)}

@media(max-width:720px){
  .item{flex-direction:column; align-items:stretch}
  .item .actions-row{justify-content:stretch}
  .item .actions-row .btn{flex:1; text-align:center}
  .topbar{flex-wrap:wrap}
  .tabs{width:100%; order:3}
}

.spinner{
  display:inline-block; width:16px; height:16px;
  border:2px solid rgba(255,255,255,.3);
  border-top-color:var(--brand-2);
  border-radius:50%; animation:spin .6s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Header / Topbar -->
  <header class="topbar">
    <div class="brand">
      <span class="logo">üé≤</span>
      <h1>El Esquinazo</h1>
    </div>
    <nav class="tabs" role="tablist" aria-label="Navegaci√≥n principal">
      <button class="tab is-active" data-tab="dashboard" aria-selected="true">Dashboard</button>
      <button class="tab" data-tab="clientes" aria-selected="false">Clientes</button>
      <button class="tab" data-tab="datos" aria-selected="false">Datos</button>
    </nav>
  </header>

  <main id="app">
    <!-- DASHBOARD -->
    <section id="dashboard" class="view is-active" aria-labelledby="tab-dashboard">
      <h2 class="sr-only" id="tab-dashboard">Panel Principal</h2>

      <!-- M√©tricas -->
      <div class="cards">
        <article class="card kpi">
          <h3>Fiado Total en la Calle</h3>
          <p id="kpi-fiado" class="kpi-value danger">$0</p>
        </article>
        <article class="card kpi">
          <h3>Clientes con Deuda</h3>
          <p id="kpi-condeuda" class="kpi-value">0</p>
        </article>
        <article class="card kpi">
          <h3>Deudas Vencidas (>30d)</h3>
          <p id="kpi-vencidas" class="kpi-value danger">0</p>
        </article>
      </div>

      <!-- Estad√≠sticas adicionales -->
      <div class="section">
        <h3>Estad√≠sticas del Mes</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Total Jugadas</div>
            <div class="stat-value" id="stat-jugadas">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Total Pagos</div>
            <div class="stat-value" id="stat-pagos">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Total Clientes</div>
            <div class="stat-value" id="stat-total-clientes">0</div>
          </div>
        </div>
      </div>

      <!-- Acciones r√°pidas -->
      <div class="section">
        <h3>Acciones R√°pidas</h3>
        <div class="actions-row">
          <button id="btn-registrar-jugada-rapida" class="btn primary">+ Registrar Jugada</button>
          <button id="btn-nuevo-cliente-rapido" class="btn">+ A√±adir Cliente</button>
        </div>
      </div>

      <!-- Atenci√≥n: Deudas vencidas -->
      <div class="section">
        <h3>Atenci√≥n: Deudas Vencidas</h3>
        <div id="lista-vencidas" class="list empty-hint"></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="view" aria-labelledby="tab-clientes">
      <h2 class="sr-only" id="tab-clientes">Gesti√≥n de Clientes</h2>

      <div class="toolbar">
        <div class="search-box">
          <input id="buscar-clientes" type="search" placeholder="Buscar cliente por nombre..." />
          <span class="kbd">/</span>
        </div>
        <button id="btn-add-cliente" class="btn primary">+ A√±adir Cliente</button>
      </div>

      <div id="lista-clientes" class="list empty-hint"></div>
    </section>

    <!-- DATOS (Backup/Restore) -->
    <section id="datos" class="view" aria-labelledby="tab-datos">
      <h2 class="sr-only" id="tab-datos">Gesti√≥n de Datos</h2>

      <div class="section">
        <h3>Backup y Restauraci√≥n</h3>
        <p style="color:var(--sub); margin-bottom:16px">
          Exporta tus datos para crear una copia de seguridad o importa datos desde un archivo previo.
        </p>
        
        <div class="actions-row">
          <button id="btn-exportar" class="btn primary">üì• Exportar Datos</button>
          <button id="btn-importar" class="btn">üì§ Importar Datos</button>
          <input type="file" id="file-importar" accept=".json" style="display:none" />
        </div>

        <div class="alert warning" style="margin-top:20px">
          <strong>‚ö†Ô∏è Importante:</strong> Al importar datos, se sobrescribir√°n todos los datos actuales. Aseg√∫rate de exportar antes si no quieres perder informaci√≥n.
        </div>
      </div>

      <div class="section">
        <h3>Informaci√≥n del Sistema</h3>
        <div class="card">
          <p style="color:var(--sub); margin:0 0 8px">Total de clientes: <strong id="info-clientes">0</strong></p>
          <p style="color:var(--sub); margin:0 0 8px">Total de movimientos: <strong id="info-movs">0</strong></p>
          <p style="color:var(--sub); margin:0">√öltima actualizaci√≥n: <strong id="info-update">-</strong></p>
        </div>
      </div>

      <div class="section">
        <h3>Zona Peligrosa</h3>
        <div class="card" style="border-color:var(--danger)">
          <p style="color:var(--sub); margin:0 0 12px">
            <strong style="color:var(--danger)">‚ö†Ô∏è Eliminar todos los datos</strong><br>
            Esta acci√≥n no se puede deshacer. Se borrar√°n todos los clientes y movimientos.
          </p>
          <button id="btn-borrar-todo" class="btn danger">üóëÔ∏è Borrar Todo</button>
        </div>
      </div>
    </section>

    <!-- VISTA FICHA CLIENTE -->
    <section id="ficha" class="view" aria-labelledby="tab-ficha" hidden>
      <div class="ficha-header">
        <button class="btn light" id="volver-clientes">‚Üê Volver</button>
        <div class="ficha-titulos">
          <h2 id="ficha-nombre">Cliente</h2>
          <p id="ficha-saldo" class="saldo">DEUDA TOTAL: $0</p>
        </div>
      </div>

      <div class="actions-row">
        <button id="btn-registrar-pago" class="btn">Registrar Pago</button>
        <button id="btn-registrar-jugada" class="btn primary">A√±adir Jugada</button>
        <button id="btn-compartir-ficha" class="btn outline">üì§ Compartir Ficha</button>
        <a id="btn-whatsapp" class="btn success" target="_blank" rel="noopener">WhatsApp</a>
      </div>

      <div class="section">
        <h3>Historial de Movimientos</h3>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripci√≥n</th>
                <th class="num">Debe</th>
                <th class="num">Haber</th>
                <th class="num">Saldo</th>
                <th class="num">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-historial"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MODAL: Cliente (Crear/Editar) -->
    <dialog id="modal-cliente" class="modal">
      <form method="dialog" class="modal-content" id="form-cliente">
        <header class="modal-header">
          <h3 id="modal-cliente-titulo">Nuevo Cliente</h3>
          <button type="button" class="icon-btn" data-close>√ó</button>
        </header>
        <div class="grid">
          <label class="full">
            <span>Nombre y Apellido *</span>
            <input name="nombre" type="text" required placeholder="Ej: Juan P√©rez" />
          </label>
          <label class="full">
            <span>N√∫mero de WhatsApp (con c√≥digo de pa√≠s)</span>
            <input name="whatsapp" type="tel" inputmode="numeric" pattern="[0-9]{7,15}" placeholder="5493492123456" />
          </label>
        </div>
        <footer class="modal-actions">
          <button class="btn" type="button" value="cancel">Cancelar</button>
          <button class="btn primary" value="ok">Guardar</button>
        </footer>
        <input type="hidden" name="id" />
      </form>
    </dialog>

    <!-- MODAL: Movimiento (Jugada / Pago) -->
    <dialog id="modal-mov" class="modal">
      <form method="dialog" class="modal-content" id="form-mov">
        <header class="modal-header">
          <h3 id="modal-mov-titulo">Registrar Movimiento</h3>
          <button type="button" class="icon-btn" data-close>√ó</button>
        </header>

        <div class="grid">
          <label>
            <span>Fecha *</span>
            <input name="fecha" type="date" required />
          </label>
          <label>
            <span>Tipo *</span>
            <select name="tipo" required>
              <option value="jugada">Jugada / Fiado</option>
              <option value="pago">Pago</option>
            </select>
          </label>
          <label class="full">
            <span>Descripci√≥n</span>
            <input name="descripcion" type="text" placeholder="Ej: Quiniela Vespertina" />
          </label>
          <label>
            <span>Monto *</span>
            <input name="monto" type="number" min="0" step="0.01" placeholder="0.00" required />
          </label>
        </div>

        <footer class="modal-actions">
          <button class="btn" type="button" value="cancel">Cancelar</button>
          <button class="btn primary" value="ok">Guardar</button>
        </footer>
        <input type="hidden" name="clienteId" />
        <input type="hidden" name="movId" />
      </form>
    </dialog>

    <!-- CONFIRM (gen√©rico) -->
    <dialog id="modal-confirm" class="modal">
      <form method="dialog" class="modal-content">
        <header class="modal-header">
          <h3>Confirmar Acci√≥n</h3>
          <button type="button" class="icon-btn" data-close>√ó</button>
        </header>
        <p id="confirm-msg" style="padding:20px; margin:0">¬øEst√°s seguro?</p>
        <footer class="modal-actions">
          <button class="btn" value="cancel">No, cancelar</button>
          <button class="btn danger" value="ok">S√≠, confirmar</button>
        </footer>
      </form>
    </dialog>

  </main>

  <footer class="footer">
    <small>¬© <span id="year"></span> El Esquinazo ‚Äì Gesti√≥n simple, r√°pida y local. Todos tus datos se guardan en tu navegador.</small>
  </footer>

  <script>
/* ============================================================
   El Esquinazo ‚Äì Gesti√≥n de Clientes (VERSI√ìN COMPLETA)
   ------------------------------------------------------------
   NUEVAS FUNCIONES:
   - Editar y eliminar movimientos individuales
   - Exportar datos (backup JSON)
   - Importar datos (restaurar desde JSON)
   - Estad√≠sticas mejoradas
   - Confirmaciones mejoradas
   ============================================================ */

(() => {
  const LS_KEY = "ESQ_CLIENTES";
  const LS_META_KEY = "ESQ_META";
  const $$ = (sel, ctx = document) => ctx.querySelector(sel);
  const $$$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

  // ---------------------- Estado ----------------------
  let state = {
    clientes: [],
    fichaClienteId: null,
  };

  // ---------------------- Helpers ----------------------
  const fmtMoney = (n) =>
    new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS", maximumFractionDigits: 0 }).format(n || 0);

  const todayISO = () => new Date().toISOString().slice(0, 10);

  const parseDate = (iso) => new Date(iso + "T00:00:00");

  const daysBetween = (isoDate) => {
    const d1 = parseDate(isoDate);
    const d2 = new Date();
    const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
    return Math.floor(diff);
  };

  const uid = () => Math.random().toString(36).slice(2, 10);

  const sanitizePhone = (p) => (p || "").replace(/\D+/g, "");

  // ---------------------- Storage ----------------------
  const save = () => {
    localStorage.setItem(LS_KEY, JSON.stringify(state.clientes));
    localStorage.setItem(LS_META_KEY, JSON.stringify({
      lastUpdate: new Date().toISOString(),
      version: "2.0"
    }));
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) return JSON.parse(raw);
    } catch(e) {
      console.error("Error loading data:", e);
    }
    return null;
  };

  const seedIfEmpty = () => {
    const existing = load();
    if (existing && Array.isArray(existing)) {
      state.clientes = existing;
      return;
    }
    // Datos de ejemplo
    state.clientes = [
      {
        id: uid(),
        nombre: "Juan P√©rez",
        whatsapp: "5493492123456",
        movs: [
          { id: uid(), fecha: isoDaysAgo(45), tipo: "jugada", descripcion: "Quiniela Nocturna", debe: 5000, haber: 0 },
          { id: uid(), fecha: isoDaysAgo(12), tipo: "pago", descripcion: "Pago parcial", debe: 0, haber: 1500 },
        ],
      },
      {
        id: uid(),
        nombre: "Carlos Rodriguez",
        whatsapp: "5493492111111",
        movs: [
          { id: uid(), fecha: isoDaysAgo(1), tipo: "jugada", descripcion: "Quiniela Vespertina", debe: 8000, haber: 0 },
          { id: uid(), fecha: isoDaysAgo(0), tipo: "pago", descripcion: "Pago de deuda", debe: 0, haber: 3500 },
        ],
      },
      {
        id: uid(),
        nombre: "Mar√≠a Gomez",
        whatsapp: "",
        movs: [
          { id: uid(), fecha: isoDaysAgo(70), tipo: "jugada", descripcion: "Quiniela Matutina", debe: 2000, haber: 0 },
        ],
      },
    ];
    save();
  };

  function isoDaysAgo(n) {
    const d = new Date();
    d.setDate(d.getDate() - n);
    return d.toISOString().slice(0, 10);
  }

  // ---------------------- Dominio / C√°lculos ----------------------
  function saldoCliente(cliente) {
    return (cliente.movs || []).reduce((acc, m) => acc + (m.debe || 0) - (m.haber || 0), 0);
  }

  function tieneDeuda(cliente) {
    return saldoCliente(cliente) > 0;
  }

  function isDeudaVencida(cliente) {
    if (!tieneDeuda(cliente)) return false;
    return (cliente.movs || []).some((m) => m.tipo === "jugada" && daysBetween(m.fecha) > 30);
  }

  function totales() {
    const fiadoTotal = state.clientes.reduce((acc, c) => acc + saldoCliente(c), 0);
    const conDeuda = state.clientes.filter(tieneDeuda).length;
    const vencidas = state.clientes.filter(isDeudaVencida).length;
    return { fiadoTotal, conDeuda, vencidas };
  }

  function estadisticasMes() {
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const anioActual = hoy.getFullYear();
    
    let jugadas = 0;
    let pagos = 0;
    
    state.clientes.forEach(c => {
      (c.movs || []).forEach(m => {
        const fecha = parseDate(m.fecha);
        if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
          if (m.tipo === "jugada") jugadas++;
          else if (m.tipo === "pago") pagos++;
        }
      });
    });
    
    return { jugadas, pagos, totalClientes: state.clientes.length };
  }

  // ---------------------- Render: Dashboard ----------------------
  function renderDashboard() {
    const { fiadoTotal, conDeuda, vencidas } = totales();
    $("#kpi-fiado").textContent = fmtMoney(fiadoTotal);
    $("#kpi-condeuda").textContent = String(conDeuda);
    $("#kpi-vencidas").textContent = String(vencidas);

    const stats = estadisticasMes();
    $("#stat-jugadas").textContent = stats.jugadas;
    $("#stat-pagos").textContent = stats.pagos;
    $("#stat-total-clientes").textContent = stats.totalClientes;

    const cont = $("#lista-vencidas");
    cont.innerHTML = "";
    const list = state.clientes
      .map((c) => ({ c, vencida: isDeudaVencida(c), saldo: saldoCliente(c) }))
      .filter((x) => x.vencida && x.saldo > 0)
      .sort((a, b) => b.saldo - a.saldo);

    if (!list.length) return;

    list.forEach(({ c, saldo }) => {
      const dias = diasDesdeUltimaJugada(c);
      const el = elVencidoItem(c, saldo, dias);
      cont.appendChild(el);
    });
  }

  function diasDesdeUltimaJugada(c) {
    const js = (c.movs || []).filter((m) => m.tipo === "jugada");
    if (!js.length) return 0;
    const last = js.sort((a, b) => parseDate(b.fecha) - parseDate(a.fecha))[0];
    return daysBetween(last.fecha);
  }

  function elVencidoItem(c, saldo, dias) {
    const wrap = document.createElement("div");
    wrap.className = "item";
    wrap.innerHTML = `
      <div class="meta">
        <div class="title">${c.nombre}</div>
        <div class="sub">
          <span class="badge red">${fmtMoney(saldo)}</span>
          <span class="badge amber">${dias} d√≠as</span>
        </div>
      </div>
      <div class="actions-row">
        ${c.whatsapp ? `<a class="btn success" target="_blank" rel="noopener" href="${waReminderHref(c, saldo, dias)}">üì± Enviar WA</a>` : ''}
        <button class="btn light" data-open-ficha="${c.id}">Ver Ficha</button>
      </div>
    `;
    return wrap;
  }

  function waReminderHref(c, saldo, dias) {
    const phone = sanitizePhone(c.whatsapp);
    const msg = `Hola ${c.nombre}, te escribo de *El Esquinazo*. Registramos una deuda de ${fmtMoney(
      saldo
    )} con ${dias} d√≠as. ¬øPodemos coordinar el pago? ¬°Gracias!`;
    const t = encodeURIComponent(msg);
    return `https://wa.me/${phone || ""}?text=${t}`;
  }

  // ---------------------- Render: Clientes ----------------------
  function renderClientes(filter = "") {
    const cont = $("#lista-clientes");
    cont.innerHTML = "";

    const q = filter.trim().toLowerCase();
    const arr = [...state.clientes].sort((a, b) => a.nombre.localeCompare(b.nombre));
    const list = q ? arr.filter((c) => c.nombre.toLowerCase().includes(q)) : arr;

    list.forEach((c) => {
      const saldo = saldoCliente(c);
      const vencida = isDeudaVencida(c);

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="meta">
          <div class="title">${c.nombre}</div>
          <div class="sub">
            <span class="badge ${saldo > 0 ? 'red' : saldo < 0 ? 'green' : ''}">${fmtMoney(saldo)}</span>
            ${vencida ? '<span class="badge amber">Vencida</span>' : ""}
          </div>
        </div>
        <div class="actions-row">
          ${c.whatsapp ? `<a class="btn success" target="_blank" rel="noopener" href="${waHref(c)}">WhatsApp</a>` : ""}
          <button class="btn light" data-edit="${c.id}">Editar</button>
          <button class="btn danger" data-del="${c.id}">Eliminar</button>
          <button class="btn primary" data-open-ficha="${c.id}">Ver Ficha</button>
        </div>
      `;
      cont.appendChild(item);
    });
  }

  function waHref(c) {
    const phone = sanitizePhone(c.whatsapp);
    const msg = `Hola ${c.nombre}, te escribo de *El Esquinazo*.`;
    return `https://wa.me/${phone || ""}?text=${encodeURIComponent(msg)}`;
  }

  // ---------------------- Render: Datos ----------------------
  function renderDatos() {
    const totalMovs = state.clientes.reduce((acc, c) => acc + (c.movs || []).length, 0);
    $("#info-clientes").textContent = state.clientes.length;
    $("#info-movs").textContent = totalMovs;
    
    try {
      const meta = JSON.parse(localStorage.getItem(LS_META_KEY) || "{}");
      if (meta.lastUpdate) {
        const fecha = new Date(meta.lastUpdate);
        $("#info-update").textContent = fecha.toLocaleString("es-AR");
      } else {
        $("#info-update").textContent = "No disponible";
      }
    } catch {
      $("#info-update").textContent = "No disponible";
    }
  }

  // ---------------------- Ficha ----------------------
  function abrirFicha(id) {
    state.fichaClienteId = id;
    const c = state.clientes.find((x) => x.id === id);
    if (!c) return;

    $("#ficha-nombre").textContent = c.nombre;
    $("#btn-whatsapp").href = waHref(c);
    if (!c.whatsapp) {
      $("#btn-whatsapp").style.display = 'none';
    } else {
      $("#btn-whatsapp").style.display = 'inline-block';
    }

    renderHistorial(c);
    switchView("ficha");
  }

  function renderHistorial(c) {
    const cuerpo = $("#tabla-historial");
    cuerpo.innerHTML = "";
    const movs = [...(c.movs || [])].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
    let saldo = 0;

    movs.forEach((m) => {
      saldo += (m.debe || 0) - (m.haber || 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fmtFecha(m.fecha)}</td>
        <td>${m.descripcion || "-"}</td>
        <td class="num">${m.debe ? fmtMoney(m.debe) : "-"}</td>
        <td class="num">${m.haber ? fmtMoney(m.haber) : "-"}</td>
        <td class="num"><strong>${fmtMoney(saldo)}</strong></td>
        <td class="num">
          <div class="actions">
            <button class="btn btn-icon light" data-edit-mov="${m.id}" title="Editar">‚úèÔ∏è</button>
            <button class="btn btn-icon danger" data-del-mov="${m.id}" title="Eliminar">üóëÔ∏è</button>
          </div>
        </td>
      `;
      cuerpo.appendChild(tr);
    });

    $("#ficha-saldo").textContent = `DEUDA TOTAL: ${fmtMoney(saldo)}`;
  }

  function fmtFecha(iso) {
    const [y, m, d] = iso.split("-");
    return `${d}/${m}/${y.slice(-2)}`;
  }

  function compartirFicha() {
    const c = currentCliente();
    if (!c) return;

    const saldo = saldoCliente(c);
    const resumen = resumenMovsTexto(c);

    const msg =
      `Hola ${c.nombre}, te env√≠o tu resumen de cuenta de *El Esquinazo*.\n\n` +
      `${resumen}\n\n` +
      `Saldo actual: *${fmtMoney(saldo)}*.\n\n` +
      `¬°Saludos!`;

    const phone = sanitizePhone(c.whatsapp);
    if (!phone) {
      alert("Este cliente no tiene WhatsApp configurado.");
      return;
    }
    const href = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(href, "_blank", "noopener");
  }

  function resumenMovsTexto(c) {
    const movs = [...(c.movs || [])].sort((a, b) => parseDate(b.fecha) - parseDate(a.fecha));
    const top = movs.slice(0, 10);
    const lines = top.map(
      (m) =>
        `‚Ä¢ ${fmtFecha(m.fecha)} ‚Äî ${m.descripcion || "-"} (${m.tipo === "jugada" ? "Debe" : "Haber"}: ${
          m.tipo === "jugada" ? fmtMoney(m.debe) : fmtMoney(m.haber)
        })`
    );
    return lines.join("\n");
  }

  function currentCliente() {
    return state.clientes.find((x) => x.id === state.fichaClienteId);
  }

  // ---------------------- Modales ----------------------
  const modCliente = $("#modal-cliente");
  const formCliente = $("#form-cliente");
  const modMov = $("#modal-mov");
  const formMov = $("#form-mov");
  const modConfirm = $("#modal-confirm");
  const confirmMsg = $("#confirm-msg");

  function openModal(modal) {
    modal.showModal();
    const closer = modal.querySelector("[data-close]");
    if (closer) closer.onclick = () => modal.close("cancel");
  }

  // Cliente modal
  function abrirNuevoCliente() {
    formCliente.reset();
    formCliente.elements["id"].value = "";
    $("#modal-cliente-titulo").textContent = "Nuevo Cliente";
    openModal(modCliente);
    setTimeout(() => formCliente.elements["nombre"].focus(), 100);
  }

  function abrirEditarCliente(id) {
    const c = state.clientes.find((x) => x.id === id);
    if (!c) return;
    formCliente.reset();
    formCliente.elements["id"].value = c.id;
    formCliente.elements["nombre"].value = c.nombre;
    formCliente.elements["whatsapp"].value = c.whatsapp || "";
    $("#modal-cliente-titulo").textContent = "Editar Cliente";
    openModal(modCliente);
  }

  formCliente.addEventListener("submit", (ev) => ev.preventDefault());
  modCliente.addEventListener("close", () => {
    if (modCliente.returnValue !== "ok") return;
    const id = formCliente.elements["id"].value || uid();
    const nombre = formCliente.elements["nombre"].value.trim();
    const whatsapp = sanitizePhone(formCliente.elements["whatsapp"].value);

    if (!nombre) return;

    const idx = state.clientes.findIndex((x) => x.id === id);
    if (idx >= 0) {
      state.clientes[idx].nombre = nombre;
      state.clientes[idx].whatsapp = whatsapp;
    } else {
      state.clientes.push({ id, nombre, whatsapp, movs: [] });
    }
    save();
    renderAll();
  });

  // Eliminar Cliente
  function confirmarEliminarCliente(id) {
    const c = state.clientes.find((x) => x.id === id);
    if (!c) return;
    confirmMsg.textContent = `¬øEliminar a "${c.nombre}" y todo su historial? Esta acci√≥n no se puede deshacer.`;
    openModal(modConfirm);
    modConfirm.onclose = () => {
      if (modConfirm.returnValue !== "ok") return;
      state.clientes = state.clientes.filter((x) => x.id !== id);
      if (state.fichaClienteId === id) {
        state.fichaClienteId = null;
        switchView("clientes");
      }
      save();
      renderAll();
    };
  }

  // Movimiento modal
  function abrirMov(tipo = "jugada", clienteId = null, movId = null) {
    formMov.reset();
    formMov.elements["clienteId"].value = clienteId || state.fichaClienteId;
    formMov.elements["movId"].value = movId || "";
    
    if (movId) {
      // Editar movimiento existente
      const c = state.clientes.find(x => x.id === (clienteId || state.fichaClienteId));
      const mov = c?.movs.find(m => m.id === movId);
      if (mov) {
        formMov.elements["fecha"].value = mov.fecha;
        formMov.elements["tipo"].value = mov.tipo;
        formMov.elements["descripcion"].value = mov.descripcion || "";
        formMov.elements["monto"].value = mov.tipo === "jugada" ? mov.debe : mov.haber;
        $("#modal-mov-titulo").textContent = "Editar Movimiento";
      }
    } else {
      // Nuevo movimiento
      formMov.elements["fecha"].value = todayISO();
      formMov.elements["tipo"].value = tipo;
      $("#modal-mov-titulo").textContent = tipo === "pago" ? "Registrar Pago" : "Registrar Jugada";
    }
    
    openModal(modMov);
    setTimeout(() => formMov.elements["monto"].focus(), 100);
  }

  formMov.addEventListener("submit", (ev) => ev.preventDefault());
  modMov.addEventListener("close", () => {
    if (modMov.returnValue !== "ok") return;
    const clienteId = formMov.elements["clienteId"].value;
    const movId = formMov.elements["movId"].value;
    const c = state.clientes.find((x) => x.id === clienteId);
    if (!c) return;

    const tipo = formMov.elements["tipo"].value;
    const fecha = formMov.elements["fecha"].value;
    const descripcion = formMov.elements["descripcion"].value.trim();
    const monto = Math.max(0, Number(formMov.elements["monto"].value || 0));

    if (!fecha || !monto) return;

    if (movId) {
      // Editar movimiento existente
      const mov = c.movs.find(m => m.id === movId);
      if (mov) {
        mov.fecha = fecha;
        mov.tipo = tipo;
        mov.descripcion = descripcion;
        mov.debe = tipo === "jugada" ? monto : 0;
        mov.haber = tipo === "pago" ? monto : 0;
      }
    } else {
      // Crear nuevo movimiento
      const mov = {
        id: uid(),
        fecha,
        tipo,
        descripcion,
        debe: tipo === "jugada" ? monto : 0,
        haber: tipo === "pago" ? monto : 0,
      };
      c.movs.push(mov);
    }

    save();
    if (state.fichaClienteId === clienteId) {
      renderHistorial(c);
    }
    renderAll();
  });

  // Eliminar movimiento
  function confirmarEliminarMov(movId) {
    const c = currentCliente();
    if (!c) return;
    const mov = c.movs.find(m => m.id === movId);
    if (!mov) return;

    confirmMsg.textContent = `¬øEliminar el movimiento "${mov.descripcion || mov.tipo}" del ${fmtFecha(mov.fecha)}?`;
    openModal(modConfirm);
    modConfirm.onclose = () => {
      if (modConfirm.returnValue !== "ok") return;
      c.movs = c.movs.filter(m => m.id !== movId);
      save();
      renderHistorial(c);
      renderAll();
    };
  }

  // ---------------------- Exportar/Importar ----------------------
  function exportarDatos() {
    const data = {
      version: "2.0",
      fecha: new Date().toISOString(),
      clientes: state.clientes
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `esquinazo-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importarDatos() {
    const input = $("#file-importar");
    input.click();
  }

  $("#file-importar").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.clientes || !Array.isArray(data.clientes)) {
          alert("Archivo inv√°lido. Debe contener un array de clientes.");
          return;
        }

        const confirmar = confirm(
          `¬øImportar ${data.clientes.length} clientes?\n\n` +
          "ADVERTENCIA: Esto sobrescribir√° todos los datos actuales. Esta acci√≥n no se puede deshacer."
        );

        if (confirmar) {
          state.clientes = data.clientes;
          save();
          renderAll();
          alert("Datos importados correctamente.");
        }
      } catch (err) {
        alert("Error al leer el archivo: " + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = "";
  });

  function borrarTodo() {
    confirmMsg.textContent = 
      "¬øELIMINAR TODOS LOS DATOS?\n\n" +
      "Se borrar√°n todos los clientes y movimientos. " +
      "Esta acci√≥n NO se puede deshacer.\n\n" +
      "Considera exportar tus datos antes de continuar.";
    
    openModal(modConfirm);
    modConfirm.onclose = () => {
      if (modConfirm.returnValue !== "ok") return;
      
      const confirmar2 = confirm("¬øEst√°s ABSOLUTAMENTE seguro? Esta acci√≥n es irreversible.");
      if (!confirmar2) return;

      state.clientes = [];
      state.fichaClienteId = null;
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_META_KEY);
      renderAll();
      alert("Todos los datos han sido eliminados.");
    };
  }

  // ---------------------- Navegaci√≥n ----------------------
  function $(sel) { return document.querySelector(sel); }
  function switchView(id) {
    $$$(".view").forEach((v) => {
      v.classList.remove("is-active");
      v.setAttribute("hidden", "");
    });
    const view = $("#"+id);
    view.classList.add("is-active");
    view.removeAttribute("hidden");
    
    $$$(".tab").forEach((t) => t.classList.remove("is-active"));
    const btn = $(`.tab[data-tab="${id}"]`);
    if (btn) btn.classList.add("is-active");

    if (id === "datos") renderDatos();
  }

  // ---------------------- Eventos UI ----------------------
  $$$(".tab").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-tab");
      switchView(id);
    });
  });

  $("#btn-nuevo-cliente-rapido").addEventListener("click", abrirNuevoCliente);
  $("#btn-registrar-jugada-rapida").addEventListener("click", () => {
    if (!state.clientes.length) { 
      alert("Primero debes agregar un cliente.");
      abrirNuevoCliente(); 
      return; 
    }
    const id = state.fichaClienteId || state.clientes[0].id;
    abrirMov("jugada", id);
  });

  $("#btn-add-cliente").addEventListener("click", abrirNuevoCliente);

  document.addEventListener("keydown", (e) => {
    if (e.key === "/" && !e.target.matches("input, textarea")) {
      e.preventDefault();
      $("#buscar-clientes").focus();
    }
  });
  $("#buscar-clientes").addEventListener("input", (e) => renderClientes(e.target.value));

  $("#lista-clientes").addEventListener("click", (e) => {
    const t = e.target;
    const editId = t.closest("[data-edit]")?.getAttribute("data-edit");
    const delId = t.closest("[data-del]")?.getAttribute("data-del");
    const fichaId = t.closest("[data-open-ficha]")?.getAttribute("data-open-ficha");
    if (editId) abrirEditarCliente(editId);
    else if (delId) confirmarEliminarCliente(delId);
    else if (fichaId) abrirFicha(fichaId);
  });

  $("#lista-vencidas").addEventListener("click", (e) => {
    const fichaId = e.target.closest("[data-open-ficha]")?.getAttribute("data-open-ficha");
    if (fichaId) abrirFicha(fichaId);
  });

  $("#volver-clientes").addEventListener("click", () => switchView("clientes"));
  $("#btn-registrar-pago").addEventListener("click", () => abrirMov("pago"));
  $("#btn-registrar-jugada").addEventListener("click", () => abrirMov("jugada"));
  $("#btn-compartir-ficha").addEventListener("click", compartirFicha);

  // Eventos de tabla de historial
  $("#tabla-historial").addEventListener("click", (e) => {
    const editBtn = e.target.closest("[data-edit-mov]");
    const delBtn = e.target.closest("[data-del-mov]");
    
    if (editBtn) {
      const movId = editBtn.getAttribute("data-edit-mov");
      abrirMov(null, state.fichaClienteId, movId);
    } else if (delBtn) {
      const movId = delBtn.getAttribute("data-del-mov");
      confirmarEliminarMov(movId);
    }
  });

  // Cerrar modales
  $$$("dialog .icon-btn[data-close]").forEach((b) => b.addEventListener("click", (e) => {
    const dlg = e.target.closest("dialog");
    if (dlg) dlg.close("cancel");
  }));

  // Cerrar modal al hacer click en el bot√≥n cancelar
  $$$(".modal-content .btn[value='cancel']").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const dlg = e.target.closest("dialog");
      if (dlg) dlg.close("cancel");
    });
  });

  // Exportar/Importar
  $("#btn-exportar").addEventListener("click", exportarDatos);
  $("#btn-importar").addEventListener("click", importarDatos);
  $("#btn-borrar-todo").addEventListener("click", borrarTodo);

  $("#year").textContent = new Date().getFullYear();

  // ---------------------- Init ----------------------
  seedIfEmpty();
  renderAll();

  function renderAll() {
    renderDashboard();
    renderClientes($("#buscar-clientes").value || "");
    if (state.fichaClienteId) {
      const c = state.clientes.find(x => x.id === state.fichaClienteId);
      if (c) renderHistorial(c);
    }
  }

  // PWA Install
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  console.log("üé≤ El Esquinazo v2.0 - Sistema cargado correctamente");
})();
  </script>
</body>
</html>
