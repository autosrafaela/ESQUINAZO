<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Esquinazo – Gestión de Clientes</title>
  
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --muted:#334155;
  --text:#e5e7eb;
  --sub:#cbd5e1;
  --brand:#22c55e;
  --brand-2:#06b6d4;
  --danger:#ef4444;
  --warning:#f59e0b;
  --ok:#10b981;
  --card:#0b1224;
  --border:#1f2937;
  --shadow: 0 6px 24px rgba(0,0,0,.35);
  --radius:16px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(180deg,var(--bg),#0b1224 60%);
  color:var(--text);
}

.login-container{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.login-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:20px;
  padding:40px;
  max-width:420px;
  width:100%;
  box-shadow:var(--shadow);
}
.login-header{
  text-align:center;
  margin-bottom:32px;
}
.login-header .logo{
  font-size:48px;
  margin-bottom:12px;
}
.login-header h1{
  margin:0 0 8px;
  font-size:28px;
}
.login-header p{
  margin:0;
  color:var(--sub);
  font-size:14px;
}

.topbar{
  position:sticky; top:0; z-index:10;
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:12px 16px;
  background:rgba(15,23,42,.95);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{display:flex; align-items:center; gap:10px}
.brand .logo{font-size:22px}
.brand h1{font-size:18px; margin:0}

.user-info{
  display:flex;
  align-items:center;
  gap:12px;
  color:var(--sub);
  font-size:14px;
}
.user-email{
  padding:6px 12px;
  background:rgba(6,182,212,.1);
  border-radius:8px;
  border:1px solid rgba(6,182,212,.3);
}

.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  background:transparent;
  border:1px solid var(--border);
  color:var(--sub);
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  transition: all .2s;
}
.tab:hover{background:rgba(255,255,255,.05)}
.tab.is-active{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:600}

main#app{padding:16px; max-width:1100px; margin-inline:auto; min-height: calc(100vh - 180px)}
.view{display:none}
.view.is-active{display:block}

.cards{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
}
@media(min-width:720px){
  .cards{grid-template-columns: repeat(3, 1fr);}
}
@media(min-width:1024px){
  .cards.five-cols{grid-template-columns: repeat(5, 1fr);}
  .cards.four-cols{grid-template-columns: repeat(4, 1fr);}
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow: var(--shadow);
}
.kpi h3{margin:0 0 6px; color:var(--sub); font-weight:500; font-size:14px}
.kpi-value{font-size:28px; margin:4px 0 0; font-weight:800; color:var(--brand-2)}
.kpi-value.danger{color:var(--danger)}
.kpi-value.success{color:var(--ok)}

.section{margin-top:22px}
.section h3{margin:0 0 10px; font-size:18px}

.btn{
  background:#121b31;
  color:var(--text);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:.2s all ease;
  font-size:14px;
  font-weight:500;
}
.btn:hover{transform:translateY(-1px); border-color:#2b3b55}
.btn:active{transform:translateY(0)}
.btn.primary{background:var(--brand-2); color:#001217; border-color:transparent; font-weight:700}
.btn.success{background:var(--ok); color:#00170f; border-color:transparent; font-weight:700; text-decoration:none; display:inline-block}
.btn.light{background:transparent; color:var(--sub)}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.btn:disabled{opacity:.5; cursor:not-allowed}
.btn.full-width{width:100%}

.actions-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.list{display:grid; gap:10px}
.empty-hint:empty::after{
  content:"Sin clientes registrados.";
  color:var(--muted);
  padding:12px 16px;
  background:rgba(255,255,255,0.02);
  border:1px dashed var(--border);
  border-radius:12px;
  display:block;
}

.item{
  display:flex; gap:12px; justify-content:space-between; align-items:center;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.item:hover{border-color:var(--muted)}
.item .meta{display:flex; flex-direction:column; gap:4px; flex:1}
.item .title{font-weight:700; font-size:16px}
.item .sub{display:flex; gap:6px; flex-wrap:wrap}
.badge{
  padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
  border:1px solid var(--border); color:var(--sub); background:#0e162b;
}
.badge.red{color:#fff; background:var(--danger); border-color:transparent}
.badge.amber{color:#1b1000; background:var(--warning); border-color:transparent}

.toolbar{
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap;
}
.search-box{position:relative; display:flex; align-items:center; flex:1; max-width:400px}
.search-box input{
  background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:12px;
  padding:10px 12px; width:100%;
}

.ficha-header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap}
.ficha-titulos h2{margin:0; font-size:24px}
.saldo{margin:4px 0 0; color:var(--sub); font-weight:700; font-size:16px}

.table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--panel)}
.table{width:100%; border-collapse:collapse; min-width:600px}
.table th, .table td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
.table thead th{background:#0c1427; color:var(--sub); font-weight:600}
.table tbody tr:hover{background:#0c1427}
.table tbody tr:last-child td{border-bottom:0}
.table .num{text-align:right}
.table .btn-icon{padding:4px 8px; font-size:12px}

.grid{display:grid; gap:12px; grid-template-columns:1fr}
@media(min-width:600px){
  .grid{grid-template-columns:repeat(2, 1fr)}
}
.grid .full{grid-column:1/-1}
label{display:block}
label span{display:block; font-size:14px; color:var(--sub); margin-bottom:6px; font-weight:500}
input, select{
  width:100%; background:#0e162b; color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px;
  font-family:inherit; font-size:14px;
}
input:focus, select:focus{outline:2px solid rgba(6,182,212,.3); border-color:var(--brand-2)}

.modal{border:0; padding:0; background:transparent; max-width:90vw}
.modal::backdrop{background:rgba(0,0,0,.7); backdrop-filter:blur(2px)}
.modal-content{
  background:var(--panel); color:var(--text);
  border:1px solid var(--border); border-radius:16px; 
  min-width:min(640px,90vw);
  padding:0; box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal-header{
  display:flex; align-items:center; justify-content:space-between; 
  padding:16px 20px; border-bottom:1px solid var(--border);
}
.modal-header h3{margin:0; font-size:18px}
.modal-actions{
  display:flex; gap:10px; justify-content:flex-end; 
  padding:16px 20px; background:#0c1427; border-top:1px solid var(--border);
  border-radius: 0 0 16px 16px;
}
.modal-body{padding:20px; max-height:70vh; overflow-y:auto}

/* ===== ESTILOS NUEVOS PARA QUINIELA ===== */
.quiniela-layout{
  display:grid; 
  gap:16px;
  grid-template-columns: 1fr;
}
@media(min-width:900px){
  .quiniela-layout{grid-template-columns: 1fr 320px;}
}

.form-quiniela{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.form-quiniela h3{
  margin:0 0 16px;
  font-size:18px;
  display:flex;
  align-items:center;
  gap:8px;
}

.resumen-mensual{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.resumen-mensual h3{
  margin:0 0 16px;
  font-size:18px;
  display:flex;
  align-items:center;
  gap:8px;
}
.resumen-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid var(--border);
}
.resumen-item:last-child{border-bottom:0}
.resumen-label{color:var(--sub); font-size:14px}
.resumen-valor{font-weight:700; font-size:16px; color:var(--brand-2)}

.chart-container{
  margin-top:24px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
}
.chart-container h3{
  margin:0 0 16px;
  font-size:18px;
}
.chart-wrapper{
  position:relative;
  height:350px;
}

.kpi-mini{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kpi-mini-label{
  font-size:11px;
  color:var(--sub);
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.kpi-mini-value{
  font-size:18px;
  font-weight:700;
  color:var(--text);
}

  </style>
</head>
<body>
  <!-- Login -->
  <div id="login" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <div class="logo">🎲</div>
        <h1>El Esquinazo</h1>
        <p>Sistema de Gestión de Clientes</p>
      </div>
      <form id="form-login" class="grid">
        <label class="full">
          <span>Email</span>
          <input type="email" name="email" placeholder="info.esquinazo@gmail.com" required autofocus/>
        </label>
        <label class="full">
          <span>Contraseña</span>
          <input type="password" name="password" placeholder="••••••••" required/>
        </label>
        <button type="submit" class="btn primary full-width">Ingresar</button>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="main-app" hidden>
    <nav class="topbar">
      <div class="brand">
        <span class="logo">🎲</span>
        <h1>El Esquinazo</h1>
      </div>
      <div class="user-info">
        <span class="user-email" id="user-email"></span>
        <button class="btn light" onclick="logout()">Cerrar Sesión</button>
      </div>
    </nav>

    <nav class="topbar" style="top:auto">
      <div class="tabs">
        <button class="tab is-active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="clientes">Clientes</button>
        <button class="tab" data-tab="quiniela">Quiniela</button>
      </div>
    </nav>

    <main id="app">
      <!-- DASHBOARD (ACTUALIZADO CON NUEVAS CARDS) -->
      <div id="dashboard" class="view is-active">
        <div class="cards five-cols">
          <div class="card kpi">
            <h3>Fiado Total</h3>
            <div class="kpi-value danger" id="kpi-fiado">$ 0</div>
          </div>
          <div class="card kpi">
            <h3>Clientes con Deuda</h3>
            <div class="kpi-value" id="kpi-condeuda">0</div>
          </div>
          <div class="card kpi">
            <h3>Deudas Vencidas</h3>
            <div class="kpi-value danger" id="kpi-vencidas">0</div>
          </div>
          <!-- NUEVAS CARDS -->
          <div class="card kpi">
            <h3>Total Clientes</h3>
            <div class="kpi-value success" id="kpi-total-clientes">0</div>
          </div>
          <div class="card kpi">
            <h3>Clientes Nuevos</h3>
            <div class="kpi-value" id="kpi-clientes-nuevos">0</div>
          </div>
        </div>

        <section class="section">
          <h3>Acciones Rápidas</h3>
          <button class="btn primary" id="btn-nuevo-cliente-rapido">+ Añadir Cliente</button>
        </section>

        <section class="section">
          <h3>Deudas Vencidas</h3>
          <div class="list" id="lista-vencidas"></div>
        </section>
      </div>

      <!-- CLIENTES -->
      <div id="clientes" class="view">
        <div class="toolbar">
          <div class="search-box">
            <input type="text" placeholder="🔍 Buscar cliente..." id="buscar-clientes"/>
          </div>
          <button class="btn primary" id="btn-add-cliente">+ Añadir Cliente</button>
        </div>
        <div class="list empty-hint" id="lista-clientes"></div>
      </div>

      <!-- NUEVA SECCIÓN: QUINIELA -->
      <div id="quiniela" class="view">
        <!-- 4 Cards principales -->
        <div class="cards four-cols">
          <div class="card kpi">
            <h3>💰 Ventas</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-ventas-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-ventas-mes">$ 0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>🎫 Tickets</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-tickets-hoy">0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-tickets-mes">0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>💳 Débitos</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-debitos-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-debitos-mes">$ 0</div>
            </div>
          </div>

          <div class="card kpi">
            <h3>💵 Comisiones</h3>
            <div class="kpi-mini">
              <span class="kpi-mini-label">Hoy</span>
              <div class="kpi-mini-value" id="quiniela-comisiones-hoy">$ 0</div>
            </div>
            <div class="kpi-mini" style="margin-top:8px">
              <span class="kpi-mini-label">Mes</span>
              <div class="kpi-value" id="quiniela-comisiones-mes">$ 0</div>
            </div>
          </div>
        </div>

        <!-- Layout: Formulario + Resumen -->
        <div class="quiniela-layout" style="margin-top:24px">
          <!-- Formulario de carga diaria -->
          <div class="form-quiniela">
            <h3>📅 Cargar Datos Diarios</h3>
            <form id="form-quiniela" class="grid">
              <label class="full">
                <span>Fecha</span>
                <input type="date" name="fecha" required/>
              </label>
              <label>
                <span>💰 Ventas</span>
                <input type="number" name="ventas" placeholder="0" step="0.01" min="0" required/>
              </label>
              <label>
                <span>🎫 Cantidad de Tickets</span>
                <input type="number" name="tickets" placeholder="0" min="0" required/>
              </label>
              <label>
                <span>💳 Débitos</span>
                <input type="number" name="debitos" placeholder="0" step="0.01" min="0" required/>
              </label>
              <label>
                <span>💵 Comisiones</span>
                <input type="number" name="comisiones" placeholder="0" step="0.01" min="0" required/>
              </label>
              <div class="full">
                <button type="submit" class="btn primary full-width">Guardar</button>
              </div>
            </form>
          </div>

          <!-- Resumen Mensual -->
          <div class="resumen-mensual">
            <h3>📊 Resumen del Mes</h3>
            <div class="resumen-item">
              <span class="resumen-label">💰 Ventas</span>
              <span class="resumen-valor" id="resumen-ventas">$ 0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">🎫 Tickets</span>
              <span class="resumen-valor" id="resumen-tickets">0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">💳 Débitos</span>
              <span class="resumen-valor" id="resumen-debitos">$ 0</span>
            </div>
            <div class="resumen-item">
              <span class="resumen-label">💵 Comisiones</span>
              <span class="resumen-valor" id="resumen-comisiones">$ 0</span>
            </div>
            <div class="resumen-item" style="margin-top:12px; padding-top:12px; border-top:2px solid var(--border)">
              <span class="resumen-label" style="font-weight:700">Días Cargados</span>
              <span class="resumen-valor" id="resumen-dias">0</span>
            </div>
          </div>
        </div>

        <!-- Gráfico -->
        <div class="chart-container">
          <h3>📈 Evolución Mensual</h3>
          <div class="chart-wrapper">
            <canvas id="chart-quiniela"></canvas>
          </div>
        </div>
      </div>

      <!-- FICHA -->
      <div id="ficha" class="view">
        <div class="ficha-header">
          <div class="ficha-titulos">
            <h2 id="ficha-nombre">-</h2>
            <div class="saldo" id="ficha-saldo">-</div>
          </div>
          <div class="actions-row">
            <button class="btn light" id="volver-clientes">← Volver</button>
            <button class="btn" onclick="abrirEditarCliente(state.fichaClienteId)">Editar</button>
            <button class="btn success" id="btn-compartir-ficha">📤 Enviar Resumen</button>
            <a class="btn success" id="btn-whatsapp" target="_blank" style="display:none">💬 WhatsApp</a>
          </div>
        </div>

        <div class="actions-row">
          <button class="btn primary" id="btn-registrar-pago">💰 Registrar Pago</button>
          <button class="btn" id="btn-registrar-jugada">🎲 Registrar Jugada</button>
        </div>

        <section class="section">
          <h3>Historial</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th class="num">Debe</th>
                  <th class="num">Haber</th>
                  <th class="num">Saldo</th>
                  <th class="num">Acciones</th>
                </tr>
              </thead>
              <tbody id="tabla-historial"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <footer style="text-align:center; padding:24px; color:var(--muted); font-size:12px">
      El Esquinazo © <span id="year"></span>
    </footer>
  </div>

  <!-- Modal Cliente -->
  <dialog class="modal" id="modal-cliente">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-cliente-titulo">Nuevo Cliente</h3>
      </div>
      <form id="form-cliente">
        <input type="hidden" name="id"/>
        <div class="modal-body">
          <div class="grid">
            <label class="full">
              <span>Nombre completo</span>
              <input type="text" name="nombre" required autofocus/>
            </label>
            <label class="full">
              <span>WhatsApp (sin +54 9)</span>
              <input type="tel" name="whatsapp" placeholder="3492123456"/>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal Movimiento -->
  <dialog class="modal" id="modal-mov">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-mov-titulo">Nuevo Movimiento</h3>
      </div>
      <form id="form-mov">
        <input type="hidden" name="clienteId"/>
        <input type="hidden" name="movId"/>
        <div class="modal-body">
          <div class="grid">
            <label>
              <span>Fecha</span>
              <input type="date" name="fecha" required/>
            </label>
            <label>
              <span>Tipo</span>
              <select name="tipo" required>
                <option value="jugada">Jugada</option>
                <option value="pago">Pago</option>
              </select>
            </label>
            <label class="full">
              <span>Descripción (opcional)</span>
              <input type="text" name="descripcion"/>
            </label>
            <label class="full">
              <span>Monto</span>
              <input type="number" name="monto" step="0.01" min="0" required/>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal Confirmación -->
  <dialog class="modal" id="modal-confirm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmar acción</h3>
      </div>
      <form>
        <div class="modal-body">
          <p id="confirm-msg"></p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn light" onclick="this.closest('dialog').close()">Cancelar</button>
          <button type="submit" class="btn danger">Eliminar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuHOmx6K4_7ke85fdlrnQlOGAfMI7bQf4",
      authDomain: "el-esquinazo-9d73f.firebaseapp.com",
      projectId: "el-esquinazo-9d73f",
      storageBucket: "el-esquinazo-9d73f.firebasestorage.app",
      messagingSenderId: "546263167857",
      appId: "1:546263167857:web:c44e73f6c41e7b81403cd0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // Estado global
    const state = {
      clientes: [],
      fichaClienteId: null,
      quinielaData: [] // Datos de quiniela
    };

    // Login
    $('#form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        $('#user-email').textContent = user.email;
        $('#login').setAttribute('hidden', '');
        $('#main-app').removeAttribute('hidden');
        await cargarDatos();
        await cargarQuinielaData();
        renderAll();
        renderQuiniela();
      } else {
        $('#login').removeAttribute('hidden');
        $('#main-app').setAttribute('hidden', '');
      }
    });

    window.logout = () => signOut(auth);

    // Firestore - Clientes
    async function cargarDatos() {
      const snap = await getDocs(collection(db, 'clientes'));
      state.clientes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function guardarCliente(c) {
      await setDoc(doc(db, 'clientes', c.id), c);
    }

    async function eliminarCliente(id) {
      await deleteDoc(doc(db, 'clientes', id));
    }

    // Firestore - Quiniela
    async function cargarQuinielaData() {
      const snap = await getDocs(collection(db, 'quiniela'));
      state.quinielaData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function guardarQuinielaRegistro(registro) {
      await setDoc(doc(db, 'quiniela', registro.id), registro);
    }

    // Utilidades
    function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function todayISO() { return new Date().toISOString().split('T')[0]; }
    function fmtMoney(n) { return '$ ' + Number(n).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function fmtFecha(iso) {
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }
    function parseDate(iso) { return new Date(iso + 'T00:00:00'); }
    function sanitizePhone(tel) {
      let clean = tel.replace(/\D/g, '');
      if (clean.startsWith('549')) return clean;
      if (clean.startsWith('9')) return '54' + clean;
      return '549' + clean;
    }
    function saldoCliente(c) {
      return (c.movs || []).reduce((sum, m) => sum + (m.debe || 0) - (m.haber || 0), 0);
    }
    function diasVencimiento(c) {
      const movs = [...(c.movs || [])].filter(m => m.debe).sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
      if (!movs.length) return 0;
      const primerFiado = parseDate(movs[0].fecha);
      const hoy = new Date();
      return Math.floor((hoy - primerFiado) / (1000 * 60 * 60 * 24));
    }

    // Renderizado Dashboard (CON NUEVAS CARDS)
    function renderDashboard() {
      const total = state.clientes.reduce((s, c) => s + saldoCliente(c), 0);
      const conDeuda = state.clientes.filter(c => saldoCliente(c) > 0).length;
      const vencidas = state.clientes.filter(c => saldoCliente(c) > 0 && diasVencimiento(c) > 30);

      $('#kpi-fiado').textContent = fmtMoney(total);
      $('#kpi-condeuda').textContent = conDeuda;
      $('#kpi-vencidas').textContent = vencidas.length;
      
      // NUEVAS CARDS
      $('#kpi-total-clientes').textContent = state.clientes.length;
      
      // Clientes nuevos del mes actual
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const clientesNuevos = state.clientes.filter(c => {
        if (!c.movs || !c.movs.length) return false;
        const primerMov = [...c.movs].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha))[0];
        return parseDate(primerMov.fecha) >= inicioMes;
      }).length;
      $('#kpi-clientes-nuevos').textContent = clientesNuevos;

      const listaVencidas = $('#lista-vencidas');
      listaVencidas.innerHTML = '';
      if (!vencidas.length) {
        listaVencidas.innerHTML = '<div style="color:var(--muted); padding:12px">✅ No hay deudas vencidas</div>';
      } else {
        vencidas.forEach(c => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="meta">
              <div class="title">${c.nombre}</div>
              <div class="sub">
                <span class="badge red">${fmtMoney(saldoCliente(c))}</span>
                <span class="badge amber">${diasVencimiento(c)} días</span>
              </div>
            </div>
            <div class="actions-row">
              <button class="btn success" onclick="abrirFicha('${c.id}')">Ver</button>
            </div>
          `;
          listaVencidas.appendChild(div);
        });
      }
    }

    function renderClientes(query = '') {
      const q = query.toLowerCase();
      const filtrados = state.clientes.filter(c => c.nombre.toLowerCase().includes(q));
      const lista = $('#lista-clientes');
      lista.innerHTML = '';
      filtrados.forEach(c => {
        const saldo = saldoCliente(c);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="meta">
            <div class="title">${c.nombre}</div>
            <div class="sub">
              ${saldo > 0 ? `<span class="badge red">${fmtMoney(saldo)}</span>` : '<span class="badge">Al día</span>'}
            </div>
          </div>
          <div class="actions-row">
            <button class="btn" onclick="abrirFicha('${c.id}')">Ver</button>
            <button class="btn light" onclick="abrirEditarCliente('${c.id}')">✏️</button>
            <button class="btn danger" onclick="confirmarEliminarCliente('${c.id}')">🗑️</button>
          </div>
        `;
        lista.appendChild(div);
      });
    }

    window.abrirFicha = function(id) {
      state.fichaClienteId = id;
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      
      $('#ficha-nombre').textContent = c.nombre;
      const saldo = saldoCliente(c);
      $('#ficha-saldo').textContent = `DEUDA: ${fmtMoney(saldo)}`;
      
      if (c.whatsapp) {
        const mensajeSimple = `Hola ${c.nombre}, te escribo de *El Esquinazo*.`;
        $('#btn-whatsapp').href = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensajeSimple)}`;
        $('#btn-whatsapp').style.display = 'inline-block';
      } else {
        $('#btn-whatsapp').style.display = 'none';
      }
      
      renderHistorial(c);
      switchView('ficha');
    };

    function renderHistorial(c) {
      const tbody = $('#tabla-historial');
      tbody.innerHTML = "";
      const movs = [...(c.movs || [])].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
      let saldo = 0;
      movs.forEach(m => {
        saldo += (m.debe || 0) - (m.haber || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtFecha(m.fecha)}</td>
          <td>${m.descripcion || "-"}</td>
          <td class="num">${m.debe ? fmtMoney(m.debe) : "-"}</td>
          <td class="num">${m.haber ? fmtMoney(m.haber) : "-"}</td>
          <td class="num"><strong>${fmtMoney(saldo)}</strong></td>
          <td class="num">
            <button class="btn btn-icon light" onclick="abrirEditarMov('${c.id}','${m.id}')">✏️</button>
            <button class="btn btn-icon danger" onclick="confirmarEliminarMov('${c.id}','${m.id}')">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function switchView(id) {
      $$('.view').forEach(v => {
        v.classList.remove('is-active');
        v.setAttribute('hidden', '');
      });
      const view = $('#'+id);
      view.classList.add('is-active');
      view.removeAttribute('hidden');
      
      $$('.tab').forEach(t => t.classList.remove('is-active'));
      const tab = $(`.tab[data-tab="${id}"]`);
      if (tab) tab.classList.add('is-active');
    }

    // Modales Cliente
    window.abrirNuevoCliente = function() {
      $('#form-cliente').reset();
      $('#form-cliente').id.value = '';
      $('#modal-cliente-titulo').textContent = 'Nuevo Cliente';
      $('#modal-cliente').showModal();
    };

    window.abrirEditarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#form-cliente').reset();
      $('#form-cliente').id.value = c.id;
      $('#form-cliente').nombre.value = c.nombre;
      $('#form-cliente').whatsapp.value = (c.whatsapp || "").replace(/^549/, "");
      $('#modal-cliente-titulo').textContent = 'Editar Cliente';
      $('#modal-cliente').showModal();
    };

    $('#form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = $('#form-cliente').id.value || uid();
      const nombre = $('#form-cliente').nombre.value.trim();
      const whatsapp = sanitizePhone($('#form-cliente').whatsapp.value);
      if (!nombre) return;

      const idx = state.clientes.findIndex(x => x.id === id);
      if (idx >= 0) {
        state.clientes[idx].nombre = nombre;
        state.clientes[idx].whatsapp = whatsapp;
        await guardarCliente(state.clientes[idx]);
      } else {
        const nuevo = { id, nombre, whatsapp, movs: [] };
        state.clientes.push(nuevo);
        await guardarCliente(nuevo);
      }
      $('#modal-cliente').close();
      renderAll();
    });

    window.confirmarEliminarCliente = function(id) {
      const c = state.clientes.find(x => x.id === id);
      if (!c) return;
      $('#confirm-msg').textContent = `¿Eliminar a "${c.nombre}" y todo su historial?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async () => {
        state.clientes = state.clientes.filter(x => x.id !== id);
        await eliminarCliente(id);
        if (state.fichaClienteId === id) {
          state.fichaClienteId = null;
          switchView('clientes');
        }
        renderAll();
      };
    };

    // Modales Movimiento
    window.abrirNuevoMov = function(tipo) {
      $('#form-mov').reset();
      $('#form-mov').fecha.value = todayISO();
      $('#form-mov').tipo.value = tipo;
      $('#form-mov').clienteId.value = state.fichaClienteId;
      $('#form-mov').movId.value = '';
      $('#modal-mov-titulo').textContent = tipo === 'pago' ? 'Registrar Pago' : 'Registrar Jugada';
      $('#modal-mov').showModal();
    };

    window.abrirEditarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#form-mov').reset();
      $('#form-mov').fecha.value = m.fecha;
      $('#form-mov').tipo.value = m.tipo;
      $('#form-mov').descripcion.value = m.descripcion || '';
      $('#form-mov').monto.value = m.tipo === 'jugada' ? m.debe : m.haber;
      $('#form-mov').clienteId.value = clienteId;
      $('#form-mov').movId.value = movId;
      $('#modal-mov-titulo').textContent = 'Editar Movimiento';
      $('#modal-mov').showModal();
    };

    $('#form-mov').addEventListener('submit', async (e) => {
      e.preventDefault();
      const clienteId = $('#form-mov').clienteId.value;
      const movId = $('#form-mov').movId.value;
      const c = state.clientes.find(x => x.id === clienteId);
      if (!c) return;

      const tipo = $('#form-mov').tipo.value;
      const fecha = $('#form-mov').fecha.value;
      const descripcion = $('#form-mov').descripcion.value.trim();
      const monto = Math.max(0, Number($('#form-mov').monto.value || 0));

      if (!fecha || !monto) return;

      if (movId) {
        const mov = c.movs.find(x => x.id === movId);
        if (mov) {
          mov.fecha = fecha;
          mov.tipo = tipo;
          mov.descripcion = descripcion;
          mov.debe = tipo === 'jugada' ? monto : 0;
          mov.haber = tipo === 'pago' ? monto : 0;
        }
      } else {
        c.movs.push({
          id: uid(),
          fecha,
          tipo,
          descripcion,
          debe: tipo === 'jugada' ? monto : 0,
          haber: tipo === 'pago' ? monto : 0,
        });
      }

      await guardarCliente(c);
      $('#modal-mov').close();
      if (state.fichaClienteId === clienteId) renderHistorial(c);
      renderAll();
    });

    window.confirmarEliminarMov = function(clienteId, movId) {
      const c = state.clientes.find(x => x.id === clienteId);
      const m = c?.movs.find(x => x.id === movId);
      if (!m) return;
      $('#confirm-msg').textContent = `¿Eliminar el movimiento "${m.descripcion || m.tipo}"?`;
      $('#modal-confirm').showModal();
      $('#modal-confirm').onsubmit = async () => {
        c.movs = c.movs.filter(x => x.id !== movId);
        await guardarCliente(c);
        renderHistorial(c);
        renderAll();
      };
    };

    // ===== NUEVA FUNCIONALIDAD: QUINIELA =====
    
    // Formulario de carga diaria
    $('#form-quiniela').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fecha = $('#form-quiniela').fecha.value;
      const ventas = Number($('#form-quiniela').ventas.value || 0);
      const tickets = Number($('#form-quiniela').tickets.value || 0);
      const debitos = Number($('#form-quiniela').debitos.value || 0);
      const comisiones = Number($('#form-quiniela').comisiones.value || 0);

      if (!fecha) return;

      const id = fecha; // Usar fecha como ID único
      const registro = {
        id,
        fecha,
        ventas,
        tickets,
        debitos,
        comisiones
      };

      // Guardar en Firebase
      await guardarQuinielaRegistro(registro);
      
      // Actualizar estado local
      const idx = state.quinielaData.findIndex(x => x.id === id);
      if (idx >= 0) {
        state.quinielaData[idx] = registro;
      } else {
        state.quinielaData.push(registro);
      }

      $('#form-quiniela').reset();
      $('#form-quiniela').fecha.value = todayISO();
      
      renderQuiniela();
      alert('✅ Datos guardados correctamente');
    });

    // Renderizar sección Quiniela
    function renderQuiniela() {
      const hoy = todayISO();
      const fechaHoy = new Date();
      const añoActual = fechaHoy.getFullYear();
      const mesActual = fechaHoy.getMonth();

      // Filtrar datos del mes actual
      const datosMes = state.quinielaData.filter(d => {
        const fecha = new Date(d.fecha + 'T00:00:00');
        return fecha.getFullYear() === añoActual && fecha.getMonth() === mesActual;
      });

      // Calcular totales del mes
      const totalesMes = datosMes.reduce((acc, d) => ({
        ventas: acc.ventas + d.ventas,
        tickets: acc.tickets + d.tickets,
        debitos: acc.debitos + d.debitos,
        comisiones: acc.comisiones + d.comisiones
      }), { ventas: 0, tickets: 0, debitos: 0, comisiones: 0 });

      // Obtener datos de hoy
      const datosHoy = state.quinielaData.find(d => d.fecha === hoy) || 
                       { ventas: 0, tickets: 0, debitos: 0, comisiones: 0 };

      // Actualizar cards principales
      $('#quiniela-ventas-hoy').textContent = fmtMoney(datosHoy.ventas);
      $('#quiniela-ventas-mes').textContent = fmtMoney(totalesMes.ventas);
      
      $('#quiniela-tickets-hoy').textContent = datosHoy.tickets;
      $('#quiniela-tickets-mes').textContent = totalesMes.tickets;
      
      $('#quiniela-debitos-hoy').textContent = fmtMoney(datosHoy.debitos);
      $('#quiniela-debitos-mes').textContent = fmtMoney(totalesMes.debitos);
      
      $('#quiniela-comisiones-hoy').textContent = fmtMoney(datosHoy.comisiones);
      $('#quiniela-comisiones-mes').textContent = fmtMoney(totalesMes.comisiones);

      // Actualizar resumen mensual
      $('#resumen-ventas').textContent = fmtMoney(totalesMes.ventas);
      $('#resumen-tickets').textContent = totalesMes.tickets;
      $('#resumen-debitos').textContent = fmtMoney(totalesMes.debitos);
      $('#resumen-comisiones').textContent = fmtMoney(totalesMes.comisiones);
      $('#resumen-dias').textContent = datosMes.length;

      // Actualizar gráfico
      renderGraficoQuiniela(datosMes);

      // Prellenar fecha de hoy en el formulario
      if (!$('#form-quiniela').fecha.value) {
        $('#form-quiniela').fecha.value = hoy;
      }
    }

    // Gráfico de Quiniela
    let chartQuiniela = null;
    function renderGraficoQuiniela(datos) {
      // Ordenar por fecha
      const datosOrdenados = [...datos].sort((a, b) => 
        new Date(a.fecha) - new Date(b.fecha)
      );

      const labels = datosOrdenados.map(d => {
        const fecha = new Date(d.fecha + 'T00:00:00');
        return `${fecha.getDate()}/${fecha.getMonth() + 1}`;
      });

      const datasets = [
        {
          label: 'Ventas',
          data: datosOrdenados.map(d => d.ventas),
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          tension: 0.3
        },
        {
          label: 'Débitos',
          data: datosOrdenados.map(d => d.debitos),
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          tension: 0.3
        },
        {
          label: 'Comisiones',
          data: datosOrdenados.map(d => d.comisiones),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.3
        },
        {
          label: 'Tickets',
          data: datosOrdenados.map(d => d.tickets),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.3,
          yAxisID: 'y1'
        }
      ];

      const ctx = $('#chart-quiniela');
      
      if (chartQuiniela) {
        chartQuiniela.destroy();
      }

      chartQuiniela = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: {
                color: '#cbd5e1',
                font: { size: 12 }
              }
            },
            tooltip: {
              backgroundColor: '#111827',
              titleColor: '#e5e7eb',
              bodyColor: '#cbd5e1',
              borderColor: '#1f2937',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              grid: { color: '#1f2937' },
              ticks: { color: '#cbd5e1' }
            },
            y: {
              type: 'linear',
              position: 'left',
              grid: { color: '#1f2937' },
              ticks: { 
                color: '#cbd5e1',
                callback: function(value) {
                  return '$ ' + value.toLocaleString('es-AR');
                }
              }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { display: false },
              ticks: { 
                color: '#cbd5e1',
                callback: function(value) {
                  return value;
                }
              }
            }
          }
        }
      });
    }

    // Eventos
    $$('.tab').forEach(btn => btn.addEventListener('click', () => {
      switchView(btn.dataset.tab);
      if (btn.dataset.tab === 'quiniela') {
        renderQuiniela();
      }
    }));
    $('#btn-nuevo-cliente-rapido').addEventListener('click', abrirNuevoCliente);
    $('#btn-add-cliente').addEventListener('click', abrirNuevoCliente);
    $('#buscar-clientes').addEventListener('input', (e) => renderClientes(e.target.value));
    $('#volver-clientes').addEventListener('click', () => switchView('clientes'));
    $('#btn-registrar-pago').addEventListener('click', () => abrirNuevoMov('pago'));
    $('#btn-registrar-jugada').addEventListener('click', () => abrirNuevoMov('jugada'));
    $('#btn-compartir-ficha').addEventListener('click', compartirFicha);
    $('#year').textContent = new Date().getFullYear();

    function compartirFicha() {
      const c = state.clientes.find(x => x.id === state.fichaClienteId);
      if (!c) return;
      
      if (!c.whatsapp) {
        alert('⚠️ Este cliente no tiene WhatsApp configurado.\n\nPuedes agregarlo editando el cliente.');
        return;
      }

      const saldo = saldoCliente(c);
      const movs = [...(c.movs || [])].sort((a, b) => parseDate(b.fecha) - parseDate(a.fecha));
      const ultimos = movs.slice(0, 10);
      
      let resumen = ultimos.map(m => {
        const tipo = m.tipo === 'jugada' ? '🎲 Jugada' : '💰 Pago';
        const monto = m.tipo === 'jugada' ? fmtMoney(m.debe) : fmtMoney(m.haber);
        const desc = m.descripcion ? ` - ${m.descripcion}` : '';
        return `${fmtFecha(m.fecha)}: ${tipo}${desc} ${monto}`;
      }).join('\n');

      const mensaje = `Hola *${c.nombre}*,\n\nTe envío el resumen de tu cuenta de *El Esquinazo*:\n\n${resumen}\n\n━━━━━━━━━━━━━━\n*SALDO ACTUAL: ${fmtMoney(saldo)}*\n━━━━━━━━━━━━━━\n\n${saldo > 0 ? '⚠️ Por favor coordina el pago lo antes posible.' : '✅ Tu cuenta está al día.'}\n\n¡Gracias!`;

      const url = `https://api.whatsapp.com/send?phone=${sanitizePhone(c.whatsapp)}&text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    }

    function renderAll() {
      renderDashboard();
      renderClientes($('#buscar-clientes').value || '');
    }

    console.log("🎲 El Esquinazo – Sistema cargado con Quiniela");
  </script>
</body>
</html>
